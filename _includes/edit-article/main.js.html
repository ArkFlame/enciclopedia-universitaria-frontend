<script>
(function() {
  var API = window.EU_CONFIG.backendUrl;
  var BASE = window.EU_CONFIG.baseUrl;
  var u = window.EditArticleUtils;

  var params = new URLSearchParams(window.location.search);
  var slug = params.get('slug');
  var articleData = null;
  var existingSources = [];
  var pendingPdf = null;

  document.addEventListener('DOMContentLoaded', async function() {
    await new Promise(function(r){ setTimeout(r, 100); });

    if (!Auth.isLoggedIn()) {
      window.location.href = BASE + '/login.html?redirect=' + encodeURIComponent(window.location.href);
      return;
    }

    if (!slug) { renderError('No se especific√≥ el art√≠culo a editar.'); return; }

    setupEventListeners();
    await loadArticle();
  });

  function setupEventListeners() {
    var uploadArea = document.getElementById('editUploadArea');
    var imageInput = document.getElementById('editImageInput');
    if (uploadArea) {
      uploadArea.addEventListener('dragover', function(e) { e.preventDefault(); this.classList.add('dragover'); });
      uploadArea.addEventListener('dragleave', function() { this.classList.remove('dragover'); });
      uploadArea.addEventListener('drop', handleEditDrop);
    }
    if (imageInput) {
      imageInput.addEventListener('change', function() { uploadEditImages(this.files); });
    }

    var ta = document.getElementById('editContent');
    if (ta) {
      ta.addEventListener('keydown', handleEditorShortcuts);
      ta.addEventListener('input', updateCharCount);
    }

    var addLinkBtn = document.getElementById('addLinkBtn');
    if (addLinkBtn) addLinkBtn.addEventListener('click', function() { if (articleData) addEditLinkSource(articleData.id); });

    var pdfInput = document.getElementById('editSrcPdfInput');
    if (pdfInput) pdfInput.addEventListener('change', function() { attachEditPdf(this); });

    var clearPdf = document.getElementById('clearPdfBtn');
    if (clearPdf) clearPdf.addEventListener('click', clearEditPdfAttach);

    var uploadPdf = document.getElementById('uploadPdfBtn');
    if (uploadPdf) uploadPdf.addEventListener('click', function() { if (articleData) uploadEditPdfSource(articleData.id); });
  }

  function handleEditorShortcuts(e) {
    var ta = e.target;
    if (e.ctrlKey || e.metaKey) {
      if (e.key === 'b') { e.preventDefault(); wrap('**','**'); }
      if (e.key === 'i') { e.preventDefault(); wrap('*','*'); }
      if (e.key === 'k') { e.preventDefault(); insertLinkEdit(); }
    }
    if (e.key === 'Tab') {
      e.preventDefault();
      var s = ta.selectionStart;
      var st = ta.scrollTop;
      ta.value = ta.value.slice(0, s) + '  ' + ta.value.slice(s);
      ta.selectionStart = ta.selectionEnd = s + 2;
      ta.scrollTop = st;
    }
  }

  function updateCharCount() {
    var ta = document.getElementById('editContent');
    var cc = document.getElementById('charCount');
    if (ta && cc) cc.textContent = ta.value.length.toLocaleString('es-AR') + ' car.';
  }

  async function loadArticle() {
    try {
      var res = await fetch(API + '/api/articles/' + encodeURIComponent(slug) + '?includePending=true');
      if (!res.ok) { var err = await res.json().catch(function(){return{};}); throw new Error(err.error || 'Error al cargar'); }
      articleData = await res.json();

      var rawContent = '';
      var contentRes = await Auth.authFetch(API + '/api/articles/by-id/' + articleData.id + '/content');
      if (contentRes && contentRes.ok) {
        var cd = await contentRes.json();
        rawContent = cd.content || '';
      }

      try {
        var srcRes = await fetch(API + '/api/articles/' + articleData.id + '/sources');
        if (srcRes.ok) {
          var srcData = await srcRes.json();
          existingSources = [].concat(srcData.pdfs || [], srcData.links || []);
        }
      } catch(e) {}

      populateEditor(articleData, rawContent);
    } catch(e) {
      renderError(e.message);
    }
  }

  function populateEditor(article, rawContent) {
    document.getElementById('editTitle').value = article.title;
    document.getElementById('editSummary').value = article.summary || '';
    document.getElementById('editContent').value = rawContent;

    var backLink = document.getElementById('backLink');
    if (backLink) backLink.href = BASE + '/articulo.html?slug=' + encodeURIComponent(article.slug);
    var cancelLink = document.getElementById('cancelLink');
    if (cancelLink) cancelLink.href = BASE + '/articulo.html?slug=' + encodeURIComponent(article.slug);
    var shortcodesLink = document.getElementById('shortcodesLink');
    if (shortcodesLink) shortcodesLink.href = BASE + '/shortcodes.html';

    var originalPreview = document.getElementById('originalPreview');
    var originalContent = document.getElementById('originalContent');
    if (rawContent) {
      if (originalContent) originalContent.textContent = rawContent;
      if (originalPreview) originalPreview.style.display = '';
    } else if (originalPreview) {
      originalPreview.style.display = 'none';
    }

    var pageTitle = document.getElementById('articleTitle');
    if (pageTitle) pageTitle.textContent = article.title;

    renderSourcesList(article.id, existingSources);
    loadExistingImages(article.id);
    updateCharCount();

    document.getElementById('editorPage').style.display = 'none';
    document.getElementById('editorContent').style.display = '';
  }

  function renderSourcesList(artId, sources) {
    var container = document.getElementById('sourcesList');
    if (!container) return;
    if (!sources.length) {
      container.innerHTML = '<div class="text-muted text-center p-2 small">No hay fuentes existentes</div>';
      return;
    }

    container.innerHTML = sources.map(function(s) {
      var icon = s.type === 'pdf'
        ? '<svg viewBox="0 0 24 24" fill="currentColor" style="width:16px;height:16px;flex-shrink:0;color:#dc2626"><path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/></svg>'
        : '<i class="bi bi-link-45deg" style="flex-shrink:0"></i>';
      return '<div class="eu-source-editor-item" data-id="' + s.id + '" data-type="' + u.escAttr(s.type) + '" data-title="' + u.escAttr(s.title) + '" data-url="' + u.escAttr(s.url || '') + '">' + icon +
        '<span class="eu-source-title">' + u.escHtml(s.title) + '</span>' +
        '<button type="button" class="eu-source-action-btn" data-action="edit">‚úèÔ∏è</button>' +
        '<button type="button" class="eu-source-insert-btn" data-action="cite">Citar</button>' +
        '<button type="button" class="eu-source-delete-btn" data-action="delete">‚úï</button>' +
        '</div>';
    }).join('');

    container.querySelectorAll('[data-action="edit"]').forEach(function(btn) {
      btn.addEventListener('click', function() {
        var parent = this.closest('[data-id]');
        if (!parent) return;
        editExistingSource(artId, parseInt(parent.dataset.id, 10), parent.dataset.type);
      });
    });
    container.querySelectorAll('[data-action="cite"]').forEach(function(btn) {
      btn.addEventListener('click', function() {
        var parent = this.closest('[data-id]');
        if (!parent) return;
        insertExistingSourceRef(parseInt(parent.dataset.id, 10), parent.dataset.title);
      });
    });
    container.querySelectorAll('[data-action="delete"]').forEach(function(btn) {
      btn.addEventListener('click', function() {
        var parent = this.closest('[data-id]');
        if (!parent) return;
        deleteExistingSource(artId, parseInt(parent.dataset.id, 10));
      });
    });
  }

  function handleEditDrop(e) {
    e.preventDefault();
    document.getElementById('editUploadArea')?.classList.remove('dragover');
    if (e.dataTransfer.files.length) uploadEditImages(e.dataTransfer.files);
  }

  async function loadExistingImages(artId) {
    try {
      var res = await fetch(API + '/api/media/article/' + artId);
      if (!res.ok) return;
      var images = await res.json();
      if (!images.length) return;
      var container = document.getElementById('editUploadedImages');
      images.forEach(function(img) {
        appendEditThumb(container, img.id, img.public_url, img.filename);
      });
    } catch(e) {}
  }

  function appendEditThumb(container, mediaId, url, filename) {
    if (!container) return;
    var altName = filename.replace(/\.[^.]+$/, '');
    var div = document.createElement('div');
    div.className = 'eu-media-thumb';
    div.dataset.mediaId = mediaId;
    div.innerHTML =
      '<img src="' + u.escHtml(url) + '" alt="' + u.escHtml(filename) + '" loading="lazy">' +
      '<div class="eu-media-thumb-overlay">' +
      '<button type="button" class="insert-img" data-url="' + u.escAttr(url) + '" data-alt="' + u.escAttr(altName) + '">üì• Insertar</button>' +
      '<button type="button" class="delete-img" data-id="' + mediaId + '" style="color:#fca5a5">üóë Eliminar</button>' +
      '</div>';
    container.appendChild(div);

    div.querySelector('.insert-img')?.addEventListener('click', function() {
      insertEditImageSC(this.dataset.url, this.dataset.alt);
    });
    div.querySelector('.delete-img')?.addEventListener('click', function() {
      deleteEditImage(parseInt(this.dataset.id, 10), this);
    });
  }

  async function deleteEditImage(mediaId, btn) {
    if (!confirm('¬øEliminar esta imagen?')) return;
    btn.disabled = true;
    btn.textContent = '...';
    var token = Auth.getToken();
    try {
      var res = await fetch(API + '/api/media/' + mediaId, {
        method: 'DELETE',
        headers: { Authorization: 'Bearer ' + token }
      });
      if (!res.ok) { var d = await res.json(); throw new Error(d.error); }
      var thumb = btn.closest('.eu-media-thumb');
      if (thumb) { thumb.style.transition='opacity .3s'; thumb.style.opacity='0'; setTimeout(function(){ thumb.remove(); }, 300); }
      u.showToast('Imagen eliminada','success');
    } catch(err) {
      u.showToast('Error: '+err.message,'error');
      btn.disabled = false;
      btn.textContent = 'üóë Eliminar';
    }
  }

  async function uploadEditImages(files) {
    if (!articleData) return;
    var formData = new FormData();
    for (var i = 0; i < files.length; i++) formData.append('images', files[i]);
    formData.append('articleId', articleData.id);
    var token = Auth.getToken();

    var prog = document.getElementById('editImgProgress');
    var bar = document.getElementById('editImgBar');
    var lbl = document.getElementById('editImgLabel');
    if (!prog || !bar || !lbl) return;
    prog.classList.remove('d-none');
    bar.style.width = '15%';
    bar.style.background = '';
    lbl.textContent = 'Subiendo ' + files.length + ' imagen(es)...';
    var ticker = setInterval(function(){ bar.style.width = Math.min(parseFloat(bar.style.width) + 7, 80) + '%'; }, 300);

    try {
      var res = await fetch(API + '/api/media/upload', {
        method: 'POST',
        headers: { Authorization: 'Bearer ' + token },
        body: formData
      });
      clearInterval(ticker);
      bar.style.width = '100%';
      var data;
      var ct = res.headers.get('content-type') || '';
      if (ct.includes('application/json')) {
        data = await res.json();
      } else {
        data = res.status === 413
          ? { error: 'Las im√°genes son demasiado grandes. L√≠mite por archivo: 5MB.' }
          : { error: 'Error del servidor (c√≥digo ' + res.status + '). Intenta de nuevo.' };
      }
      if (!res.ok) throw new Error(data.error);
      lbl.textContent = '‚úì ' + data.files.length + ' imagen(es) subida(s)';
      setTimeout(function(){ prog.classList.add('d-none'); }, 2500);
      var container = document.getElementById('editUploadedImages');
      data.files.forEach(function(f) { appendEditThumb(container, f.id, f.publicUrl, f.filename); });
      u.showToast(data.files.length + ' imagen(es) subida(s)', 'success');
    } catch(err) {
      clearInterval(ticker);
      bar.style.width = '100%';
      bar.style.background = 'var(--eu-danger)';
      lbl.textContent = '‚úó ' + err.message;
      setTimeout(function(){ prog.classList.add('d-none'); bar.style.background = ''; }, 3500);
      u.showToast(err.message,'error');
    }
  }

  function showEditSourceMsg(type, msg) {
    var el = document.getElementById('editSourcesMsg');
    if (!el) return;
    el.innerHTML = '<div class="alert alert-' + type + ' py-2 px-3 small mb-0">' + u.escHtml(msg) + '</div>';
    setTimeout(function(){ if(el) el.innerHTML = ''; }, 3500);
  }

  async function editExistingSource(artId, srcId, type) {
    var source = existingSources.find(function(x) { return x.id === srcId; });
    if (!source) return;
    var newTitle = prompt('T√≠tulo:', source.title);
    if (newTitle === null) return;
    var payload = { title: newTitle.trim() || source.title };
    if (type === 'link') {
      var newUrl = prompt('URL:', source.url || '');
      if (newUrl !== null && newUrl.trim()) {
        try { new URL(newUrl.trim()); payload.url = newUrl.trim(); } catch(e) { u.showToast('URL inv√°lida','error'); return; }
      }
    }
    var token = Auth.getToken();
    try {
      var res = await fetch(API + '/api/articles/' + artId + '/sources/' + srcId, {
        method: 'PUT',
        headers: { 'Content-Type':'application/json', Authorization:'Bearer ' + token },
        body: JSON.stringify(payload)
      });
      if (!res.ok) { var d = await res.json(); throw new Error(d.error); }
      source.title = payload.title;
      if (payload.url) source.url = payload.url;
      renderSourcesList(artId, existingSources);
      u.showToast('Fuente actualizada','success');
    } catch(e) {
      u.showToast('Error: ' + e.message,'error');
    }
  }

  async function deleteExistingSource(artId, srcId) {
    if (!confirm('¬øEliminar esta fuente?')) return;
    var token = Auth.getToken();
    try {
      var res = await fetch(API + '/api/articles/' + artId + '/sources/' + srcId, {
        method: 'DELETE',
        headers: { Authorization: 'Bearer ' + token }
      });
      if (!res.ok) throw new Error('Error al eliminar');
      existingSources = existingSources.filter(function(s) { return s.id !== srcId; });
      renderSourcesList(artId, existingSources);
      u.showToast('Fuente eliminada','success');
    } catch(e) {
      u.showToast(e.message,'error');
    }
  }

  async function addEditLinkSource(artId) {
    if (!artId) return;
    var title = document.getElementById('editSrcLinkTitle').value.trim();
    var url = document.getElementById('editSrcLinkUrl').value.trim();
    if (!title || !url) { showEditSourceMsg('warning','T√≠tulo y URL requeridos'); return; }
    try { new URL(url); } catch(e) { showEditSourceMsg('warning','URL inv√°lida'); return; }

    var btn = document.getElementById('addLinkBtn');
    btn.disabled = true;
    btn.innerHTML = '<span class="eu-spinner" style="width:14px;height:14px;border-width:2px"></span> A√±adiendo...';
    var token = Auth.getToken();
    try {
      var res = await fetch(API + '/api/articles/' + artId + '/sources', {
        method: 'POST',
        headers: { 'Content-Type':'application/json', Authorization:'Bearer ' + token },
        body: JSON.stringify({ type:'link', title:title, url:url })
      });
      var data = await res.json();
      if (!res.ok) throw new Error(data.error);
      document.getElementById('editSrcLinkTitle').value = '';
      document.getElementById('editSrcLinkUrl').value = '';
      showEditSourceMsg('success','üîó Enlace a√±adido');
      var newSource = data.source || { id: Date.now(), type: 'link', title: title, url: url };
      existingSources.push(newSource);
      renderSourcesList(artId, existingSources);
    } catch(e) {
      showEditSourceMsg('danger', u.escHtml(e.message));
    } finally {
      btn.disabled = false;
      btn.innerHTML = '<i class="bi bi-plus-circle"></i> A√±adir enlace';
    }
  }

  function attachEditPdf(input) {
    var file = input.files[0];
    if (!file) return;
    if (file.size > 10 * 1024 * 1024) { showEditSourceMsg('warning','PDF supera 10MB'); input.value=''; return; }
    pendingPdf = { file: file, name: file.name };
    var title = document.getElementById('editSrcPdfTitle').value.trim() || file.name.replace(/\.pdf$/i,'');
    document.getElementById('editSrcPdfTitle').value = title;
    document.getElementById('editPdfPreviewName').textContent = file.name + ' (' + u.fmtSize(file.size) + ')';
    document.getElementById('editPdfPreview').classList.remove('d-none');
    document.getElementById('uploadPdfBtn').classList.remove('d-none');
    document.getElementById('editPdfAttachZone').classList.add('d-none');
  }

  function clearEditPdfAttach() {
    pendingPdf = null;
    document.getElementById('editSrcPdfInput').value = '';
    document.getElementById('editPdfPreview').classList.add('d-none');
    document.getElementById('uploadPdfBtn').classList.add('d-none');
    document.getElementById('editPdfAttachZone').classList.remove('d-none');
  }

  async function uploadEditPdfSource(artId) {
    if (!pendingPdf || !artId) return;
    var title = document.getElementById('editSrcPdfTitle').value.trim() || pendingPdf.name.replace(/\.pdf$/i,'');
    var btn = document.getElementById('uploadPdfBtn');
    btn.disabled = true;
    btn.innerHTML = '<span class="eu-spinner" style="width:14px;height:14px;border-width:2px"></span> Subiendo...';
    var token = Auth.getToken();
    var fd = new FormData();
    fd.append('pdf', pendingPdf.file);
    fd.append('title', title);
    try {
      var res = await fetch(API + '/api/articles/' + artId + '/sources/pdf', {
        method: 'POST',
        headers: { Authorization: 'Bearer ' + token },
        body: fd
      });
      var data = await res.json();
      if (!res.ok) throw new Error(data.error);
      clearEditPdfAttach();
      document.getElementById('editSrcPdfTitle').value = '';
      showEditSourceMsg('success','üìÑ PDF subido exitosamente');
      var newSource = data.source || { id: Date.now(), type: 'pdf', title: title };
      existingSources.push(newSource);
      renderSourcesList(artId, existingSources);
    } catch(e) {
      showEditSourceMsg('danger', u.escHtml(e.message));
      btn.disabled = false;
      btn.innerHTML = '<i class="bi bi-upload"></i> Subir PDF';
    }
  }

  window.submitEdit = async function() {
    if (!articleData) return;
    var articleId = articleData.id;
    var title = document.getElementById('editTitle')?.value.trim();
    var summary = document.getElementById('editSummary')?.value.trim();
    var content = document.getElementById('editContent')?.value.trim();
    var note = document.getElementById('editNote')?.value.trim();
    var msgEl = document.getElementById('submitMsg');
    var btn = document.getElementById('submitBtn');
    var spinner = document.getElementById('submitSpinner');

    if (!content) {
      if (msgEl) msgEl.innerHTML = '<div class="alert alert-warning mb-3"><i class="bi bi-exclamation-triangle me-2"></i>El contenido no puede estar vac√≠o.</div>';
      return;
    }
    btn.disabled = true;
    spinner.classList.remove('d-none');
    msgEl.innerHTML = '';

    try {
      var res = await Auth.authFetch(API + '/api/articles/' + articleId + '/edit', {
        method: 'POST',
        body: JSON.stringify({ title:title, summary:summary, content:content, editNote:note })
      });
      var data = await res.json();
      if (!res.ok) throw new Error(data.error || 'Error al enviar edici√≥n');
      msgEl.innerHTML = '<div class="alert alert-success mb-4"><i class="bi bi-check-circle-fill me-2"></i><strong>¬°Edici√≥n enviada!</strong> Un moderador la revisar√°.<div class="mt-3"><a href="' + BASE + '/articulo.html?slug=' + encodeURIComponent(slug) + '" class="btn btn-sm btn-outline-success">Ver art√≠culo original</a></div></div>';
      document.querySelectorAll('.eu-card').forEach(function(el){ el.style.display='none'; });
    } catch(e) {
      msgEl.innerHTML = '<div class="alert alert-danger mb-3"><i class="bi bi-x-circle me-2"></i>' + u.escHtml(e.message) + '</div>';
    } finally {
      btn.disabled = false;
      spinner.classList.add('d-none');
    }
  };

  function renderError(msg) {
    document.getElementById('editorContent').style.display = 'none';
    document.getElementById('editorPage').innerHTML = 
      '<div class="eu-empty-state" style="min-height:50vh">' +
      '<i class="bi bi-exclamation-circle" style="font-size:3rem;color:var(--eu-danger)"></i>' +
      '<h3 class="mt-3">No se puede cargar el editor</h3>' +
      '<p class="text-muted">' + u.escHtml(msg) + '</p>' +
      '<a href="' + BASE + '/" class="eu-btn-primary mt-3">Ir al inicio</a></div>';
  }
})();
</script>
