---
layout: default
title: Cargando artículo...
---

<div id="articlePage">
  <div class="eu-loading" style="min-height:60vh">
    <div class="eu-spinner"></div>
    <span>Cargando artículo...</span>
  </div>
</div>

<script>
(async function() {
  const API = window.EU_CONFIG.backendUrl;
  const BASE = window.EU_CONFIG.baseUrl;
  const params = new URLSearchParams(window.location.search);
  const slug = params.get('slug');

  if (!slug) {
    document.getElementById('articlePage').innerHTML = `
      <div class="eu-empty-state">
        <i class="bi bi-exclamation-triangle"></i>
        <h3>Artículo no especificado</h3>
        <a href="${BASE}/" class="eu-btn-primary mt-3">Volver al inicio</a>
      </div>`;
    return;
  }

  const includePending = localStorage.getItem('eu_show_pending') === 'true';
  const token = localStorage.getItem('eu_token');
  const url = new URL(`${API}/api/articles/${encodeURIComponent(slug)}`);
  if (includePending) url.searchParams.set('includePending', 'true');

  const headers = {};
  if (token) headers['Authorization'] = `Bearer ${token}`;

  try {
    const res = await fetch(url, { headers });
    
    if (res.status === 404) {
      document.getElementById('articlePage').innerHTML = `
        <div class="eu-empty-state">
          <i class="bi bi-journal-x"></i>
          <h3>Artículo no encontrado</h3>
          <p class="text-muted">Es posible que haya sido movido o eliminado.</p>
          <a href="${BASE}/" class="eu-btn-primary mt-3">Volver al inicio</a>
        </div>`;
      return;
    }

    if (!res.ok) throw new Error('Error al cargar el artículo');

    const data = await res.json();
    document.title = `${data.title} — Enciclopedia Universitaria`;

    const user = (() => { try { return JSON.parse(localStorage.getItem('eu_user')); } catch { return null; } })();
    const statusBadge = data.status !== 'APPROVED'
      ? `<span class="eu-status-badge eu-status-${data.status} me-2">${data.status === 'PENDING' ? '⏳ Pendiente de aprobación' : '✕ Rechazado'}</span>`
      : '<span class="eu-status-badge eu-status-APPROVED">✓ Aprobado</span>';

    const canEdit = user && (user.role === 'ADMIN' || user.role === 'MOD' || user.id === data.author_id);

    let contentHtml;
    if (data.limitReached) {
      contentHtml = renderPaywall(data);
    } else if (data.htmlContent) {
      contentHtml = `<div class="eu-article-content" id="articleContent">${data.htmlContent}</div>`;
    } else {
      contentHtml = `<div class="eu-loading"><div class="eu-spinner"></div></div>`;
    }

    const relatedHtml = data.related?.length ? `
      <div class="eu-sidebar-widget">
        <h4>Artículos relacionados</h4>
        <div class="d-flex flex-column gap-2">
          ${data.related.map(r => `
            <a href="${BASE}/articulo.html?slug=${encodeURIComponent(r.slug)}" class="text-decoration-none">
              <div class="small fw-semibold" style="color:var(--eu-text)">${escapeHtml(r.title)}</div>
              <div class="small text-muted" style="display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden">${escapeHtml(r.summary)}</div>
            </a>`).join('<hr class="my-1">')}
        </div>
      </div>` : '';

    const mediaHtml = data.media?.length ? `
      <div class="eu-sidebar-widget">
        <h4>Multimedia (${data.media.length})</h4>
        <div class="row g-2">
          ${data.media.map(m => `
            <div class="col-6">
              <img src="${escapeHtml(m.public_url)}" alt="${escapeHtml(m.filename)}" 
                   class="img-fluid rounded" loading="lazy" style="cursor:pointer;max-height:80px;object-fit:cover;width:100%"
                   onclick="window.open('${escapeHtml(m.public_url)}','_blank')">
            </div>`).join('')}
        </div>
      </div>` : '';

    // Render sources (PDFs first, then links)
    const sources = data.sources || [];
    const pdfSources = sources.filter(s => s.type === 'pdf');
    const linkSources = sources.filter(s => s.type === 'link');
    
    const sourcesHtml = sources.length ? `
      <div class="eu-sidebar-widget">
        <h4><i class="bi bi-link-45deg me-1"></i>Fuentes</h4>
        <div class="eu-sources-list">
          ${pdfSources.map(s => `
            <a href="${BASE}/api/sources/sources/pdf/${s.id}" target="_blank" class="eu-source-item eu-source-pdf">
              <i class="bi bi-file-earmark-pdf-fill"></i>
              <span class="eu-source-title">${escapeHtml(s.title)}</span>
              <span class="eu-source-size">${formatFileSize(s.pdf_size)}</span>
            </a>
          `).join('')}
          ${linkSources.map(s => `
            <a href="${escapeHtml(s.url)}" target="_blank" rel="noopener noreferrer" class="eu-source-item eu-source-link">
              <img src="${escapeHtml(s.favicon_url)}" alt="" class="eu-source-favicon" onerror="this.style.display='none'">
              <span class="eu-source-title">${escapeHtml(s.title)}</span>
            </a>
          `).join('')}
        </div>
      </div>` : '';

    document.getElementById('articlePage').innerHTML = `
      <div class="eu-article-wrapper">
        <!-- Artículo principal -->
        <article>
          <header class="eu-article-header">
            <div class="d-flex align-items-center gap-2 mb-3 flex-wrap">
              ${statusBadge}
              ${data.category ? `<span class="eu-category-tag">${escapeHtml(data.category)}</span>` : ''}
            </div>
            <h1 class="eu-article-title">${escapeHtml(data.title)}</h1>
            <div class="eu-article-meta">
              <span><i class="bi bi-person-fill"></i> <strong>${escapeHtml(data.author_username)}</strong></span>
              <span>·</span>
              <span><i class="bi bi-calendar3"></i> ${formatDate(data.created_at)}</span>
              ${data.reviewed_at ? `<span>·</span><span><i class="bi bi-check-circle"></i> Revisado: ${formatDate(data.reviewed_at)}</span>` : ''}
              <span>·</span>
              <span><i class="bi bi-eye"></i> ${(data.views + 1).toLocaleString('es-AR')} vistas</span>
              ${data.version > 1 ? `<span>·</span><span><i class="bi bi-clock-history"></i> v${data.version}</span>` : ''}
            </div>
          </header>

          ${data.rejection_reason ? `
            <div class="alert alert-danger mb-4">
              <strong>Motivo de rechazo:</strong> ${escapeHtml(data.rejection_reason)}
            </div>` : ''}

          <div class="eu-article-summary mb-4 p-3 rounded" style="background:var(--eu-bg-secondary);border-left:3px solid var(--eu-text)">
            <p class="m-0" style="font-size:1.05rem;color:var(--eu-text-secondary);font-style:italic">${escapeHtml(data.summary)}</p>
          </div>

          ${contentHtml}

          <!-- Acciones del artículo -->
          <div class="eu-divider"></div>
          <div class="d-flex gap-2 flex-wrap">
            ${user
              ? `<a href="${BASE}/editar-articulo.html?slug=${encodeURIComponent(data.slug)}&id=${data.id}" class="eu-btn-outline eu-btn-sm"><i class="bi bi-pencil"></i> Proponer edición</a>`
              : `<a href="${BASE}/login.html" class="eu-btn-outline eu-btn-sm"><i class="bi bi-pencil"></i> Proponer edición</a>`}
            <button class="eu-btn-outline eu-btn-sm" onclick="copyLink()"><i class="bi bi-link-45deg"></i> Copiar enlace</button>
          </div>
        </article>

        <!-- Sidebar -->
        <aside class="eu-article-sidebar">
          ${relatedHtml}
          ${mediaHtml}
          ${sourcesHtml}
          <div class="eu-sidebar-widget">
            <h4>Sobre este artículo</h4>
            <div class="small" style="color:var(--eu-text-secondary)">
              <div class="mb-1">Autor: <strong>${escapeHtml(data.author_username)}</strong></div>
              <div class="mb-1">Versión: <strong>${data.version}</strong></div>
              ${data.category ? `<div class="mb-1">Categoría: <strong>${escapeHtml(data.category)}</strong></div>` : ''}
              <div>Publicado: <strong>${formatDate(data.created_at)}</strong></div>
            </div>
          </div>
        </aside>
      </div>`;

    // Inicializar componentes tras renderizar
    window.dispatchEvent(new Event('eu:content-loaded'));

    // MathJax para fórmulas
    if (document.querySelector('.eu-formula')) {
      const script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      document.head.appendChild(script);
    }

  } catch (err) {
    document.getElementById('articlePage').innerHTML = `
      <div class="eu-empty-state text-danger">
        <i class="bi bi-exclamation-triangle"></i>
        <h3>Error al cargar el artículo</h3>
        <p>${err.message}</p>
        <a href="${BASE}/" class="eu-btn-primary mt-3">Volver al inicio</a>
      </div>`;
  }

  function renderPaywall(data) {
    const limit = data.freeLimit || 30;
    return `
      <div style="position:relative">
        <div style="max-height:200px;overflow:hidden;mask-image:linear-gradient(to bottom,black 40%,transparent);-webkit-mask-image:linear-gradient(to bottom,black 40%,transparent)">
          <p class="eu-article-content" style="color:var(--eu-text-secondary)">${escapeHtml(data.summary)}</p>
        </div>
        <div class="eu-paywall">
          <div class="eu-paywall-title">Límite de lectura mensual alcanzado</div>
          <p class="text-muted">Has leído tus ${limit} artículos gratuitos de este mes.</p>
          <div class="eu-paywall-price">$1.000 <small>ARS/mes</small></div>
          <ul class="eu-paywall-features">
            <li>Artículos ilimitados</li>
            <li>Acceso a contenido exclusivo</li>
            <li>Sin interrupciones publicitarias</li>
            <li>Soporte a la comunidad universitaria</li>
          </ul>
          <a href="${BASE}/suscripcion.html" class="eu-btn-primary btn-lg">
            <i class="bi bi-star-fill"></i> Compra Acceso para seguir leyendo
          </a>
          <div class="mt-3">
            <a href="${BASE}/login.html" class="text-muted small">¿Ya tienes cuenta? Inicia sesión</a>
          </div>
        </div>
      </div>`;
  }

  function escapeHtml(s) {
    return String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&gt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }

  function formatFileSize(bytes) {
    if (!bytes) return '';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
  }

  window.copyLink = function() {
    navigator.clipboard.writeText(window.location.href).then(() => {
      window.showToast('Enlace copiado al portapapeles', 'success');
    });
  };
})();
</script>
