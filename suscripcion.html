---
layout: default
title: SuscripciÃ³n â€” Acceso Completo
use_mercadopago: true
---

<div style="min-height:70vh;padding:40px 0">
  <div style="max-width:680px;margin:0 auto;text-align:center">

    <div class="mb-4">
      <span style="font-size:3rem">ðŸ“š</span>
      <h1 style="font-family:var(--eu-font-display);font-size:2.2rem;font-weight:700;margin-top:12px">
        Acceso completo a la Enciclopedia
      </h1>
      <p class="text-muted" style="font-size:1.05rem;margin-top:8px">
        Desbloquea conocimiento ilimitado por solo $1.000 ARS al mes
      </p>
    </div>

    <div class="eu-stat-card p-5 mb-4" style="background:var(--eu-surface);border:2px solid var(--eu-text)">
      <div class="eu-paywall-price mb-4">
        $1.000 <small style="font-size:1rem;color:var(--eu-text-muted);font-weight:400">ARS/mes</small>
      </div>

      <ul class="eu-paywall-features mb-5">
        <li>ArtÃ­culos ilimitados todos los meses</li>
        <li>Acceso a contenido pendiente de aprobaciÃ³n</li>
        <li>Mayor lÃ­mite de publicaciones (10/hora)</li>
        <li>Soporte a la comunidad universitaria</li>
        <li>Sin restricciones de lectura</li>
        <li>Cancela cuando quieras</li>
      </ul>

      <div id="paymentSection">
        <div class="eu-loading">
          <div class="eu-spinner"></div>
          <span>Cargando opciones de pago...</span>
        </div>
      </div>
    </div>

    <div class="text-muted small">
      <i class="bi bi-shield-check me-1"></i> Pago seguro via MercadoPago Â·
      <i class="bi bi-calendar-check me-1"></i> RenovaciÃ³n mensual Â·
      <i class="bi bi-x-circle me-1"></i> CancelaciÃ³n fÃ¡cil
    </div>
    <div class="mt-4 text-muted small">
      Â¿Tienes preguntas? <a href="mailto:contacto@enciclopedia.edu">ContÃ¡ctanos</a>
    </div>
  </div>
</div>

<script>
(function () {
  const API     = window.EU_CONFIG.backendUrl;
  const BASE    = window.EU_CONFIG.baseUrl;
  const section = document.getElementById('paymentSection');

  function setHtml(html) { section.innerHTML = html; }

  function showDirectButton(initPoint) {
    setHtml(`
      <a href="${initPoint}"
         class="eu-btn-primary w-100 justify-content-center"
         style="font-size:1.1rem;padding:16px 24px;display:flex;align-items:center;gap:10px;text-decoration:none">
        <img src="https://http2.mlstatic.com/frontend-assets/mp-web-navigation/ui-navigation/5.21.22/mercadopago/logo__small@2x.png"
             alt="MercadoPago" style="height:20px;filter:brightness(0)invert(1)">
        Pagar con MercadoPago
      </a>
      <p class="text-muted small mt-3">SerÃ¡s redirigido a MercadoPago de forma segura para completar el pago.</p>`);
  }

  document.addEventListener('DOMContentLoaded', async () => {
    // Refresh token first so role is current
    await Auth.refreshToken();
    const user = Auth.getUser();

    if (!Auth.isLoggedIn()) {
      setHtml(`
        <p class="text-muted mb-3">Para suscribirte necesitas una cuenta</p>
        <a href="${BASE}/login.html?redirect=${encodeURIComponent(window.location.href)}"
           class="eu-btn-primary btn-lg">
          <i class="bi bi-person-fill"></i> Iniciar sesiÃ³n
        </a>
        <div class="mt-2">
          <a href="${BASE}/login.html" class="text-muted small">Â¿No tienes cuenta? RegÃ­strate gratis</a>
        </div>`);
      return;
    }

    if (['MONTHLY', 'ADMIN', 'MOD'].includes(user?.role)) {
      setHtml(`
        <div class="alert alert-success">
          <i class="bi bi-check-circle-fill me-2"></i>
          <strong>Â¡Ya tienes acceso completo!</strong>
          Tu cuenta tiene rol <strong>${user.role}</strong>.
        </div>
        <a href="${BASE}/" class="eu-btn-primary">Ver enciclopedia</a>`);
      return;
    }

    // Create payment preference â€” public key comes from backend response
    try {
      const res  = await Auth.authFetch(`${API}/api/payments/create-preference`, { method: 'POST' });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'Error al crear preferencia de pago');

      const { preferenceId, initPoint, sandboxInitPoint, publicKey } = data;

      if (!preferenceId || !initPoint) {
        throw new Error('Respuesta incompleta del servidor de pagos');
      }

      if (!publicKey) {
        // No public key â†’ use direct link fallback immediately
        console.warn('MP public key not returned by backend, using direct link');
        showDirectButton(initPoint);
        return;
      }

      // Try to render MercadoPago Wallet Brick
      setHtml(`<div id="walletBrick_container"></div>
               <div class="text-muted small mt-3">Al completar el pago tu cuenta se actualiza automÃ¡ticamente.</div>`);

      // Wait for MP SDK to load (it's loaded with defer in layout)
      let attempts = 0;
      const tryInit = async () => {
        if (typeof MercadoPago === 'undefined') {
          if (++attempts < 20) {
            setTimeout(tryInit, 300);
          } else {
            console.warn('MercadoPago SDK did not load, falling back to direct link');
            showDirectButton(initPoint);
          }
          return;
        }
        try {
          const mp  = new MercadoPago(publicKey, { locale: 'es-AR' });
          const bricks = mp.bricks();
          await bricks.create('wallet', 'walletBrick_container', {
            initialization: {
              preferenceId,
              redirectMode: 'modal'  // stays on page after payment
            },
            customization: {
              texts:    { valueProp: 'smart_option' },
              visual:   { buttonBackground: 'black', borderRadius: '8px' }
            },
            callbacks: {
              onError: (error) => {
                console.error('MP Brick error:', error);
                showDirectButton(initPoint);
              }
            }
          });
        } catch (brickErr) {
          console.error('Failed to create MP brick:', brickErr);
          showDirectButton(initPoint);
        }
      };
      tryInit();

    } catch (err) {
      setHtml(`
        <div class="alert alert-danger text-start">
          <i class="bi bi-exclamation-circle me-2"></i>
          <strong>Error al cargar el pago:</strong> ${err.message}
        </div>
        <p class="text-muted small mt-2">Intenta recargar la pÃ¡gina o contacta con soporte.</p>`);
    }
  });
})();
</script>
