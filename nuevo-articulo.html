---
layout: default
title: Nuevo artÃ­culo
---

<div id="editorPage">
  <div class="eu-loading" style="min-height:60vh">
    <div class="eu-spinner"></div>
    <span>Cargando editor...</span>
  </div>
</div>

<script>
(function() {
  var API = window.EU_CONFIG.backendUrl;
  var BASE = window.EU_CONFIG.baseUrl;
  var articleId = null;
  var localSources = [];
  var pendingPdf = null;

  document.addEventListener('DOMContentLoaded', function() {
    if (!Auth.isLoggedIn()) {
      window.location.href = BASE + '/login.html?redirect=' + encodeURIComponent(window.location.href);
      return;
    }
    renderEditor();
  });

  async function loadCategories() {
    try {
      var res = await fetch(API + '/api/articles/meta/categories');
      if (!res.ok) return [];
      return await res.json();
    } catch(e) { return []; }
  }

  async function renderEditor() {
    var cats = await loadCategories();
    var catOptions = cats.map(function(c){ return '<option value="' + c.slug + '">' + c.name + '</option>'; }).join('');

    document.getElementById('editorPage').innerHTML = [
      '<div style="max-width:1200px;margin:0 auto">',
      '<div class="d-flex align-items-center justify-content-between mb-4 flex-wrap gap-3">',
      '<div><h1 class="eu-section-title">Nuevo artÃ­culo</h1>',
      '<p class="eu-section-subtitle">Usa Markdown y shortcodes para crear contenido interactivo.</p></div>',
      '<a href="' + BASE + '/shortcodes.html" class="eu-btn-outline eu-btn-sm" target="_blank"><i class="bi bi-code-slash"></i> GuÃ­a de shortcodes</a>',
      '</div>',
      '<div id="publishAlert" class="alert d-none mb-4"></div>',
      '<div class="row g-4">',
      '<div class="col-lg-8">',
      '<div class="eu-card p-4 mb-4">',
      '<h5 class="mb-3">InformaciÃ³n del artÃ­culo</h5>',
      '<div class="eu-form-group">',
      '<label class="eu-label" for="artTitle">TÃ­tulo <span class="text-danger">*</span></label>',
      '<input type="text" id="artTitle" class="eu-input" placeholder="Ej: La fotosÃ­ntesis en plantas C4" maxlength="500">',
      '</div>',
      '<div class="eu-form-group">',
      '<label class="eu-label">Resumen <span class="text-danger">*</span> <span class="text-muted small fw-normal">â€” soporta Markdown</span></label>',
      '<div class="eu-summary-toolbar">',
      '<button class="eu-editor-btn" type="button" onclick="summaryWrap(\'**\',\'**\')" title="Negrita"><b>B</b></button>',
      '<button class="eu-editor-btn" type="button" onclick="summaryWrap(\'*\',\'*\')" title="Cursiva"><i>I</i></button>',
      '<button class="eu-editor-btn" type="button" onclick="summaryLine(\'- \')" title="Lista">â€¢ Lista</button>',
      '<button class="eu-editor-btn" type="button" onclick="summaryLine(\'1. \')" title="Lista numerada">1. Lista</button>',
      '<button class="eu-editor-btn" type="button" onclick="summaryAnchor()" title="Ancla">âš“ SecciÃ³n</button>',
      '</div>',
      '<textarea id="artSummary" class="eu-textarea eu-summary-textarea" placeholder="Breve descripciÃ³n" maxlength="4000" rows="4"></textarea>',
      '<div class="text-muted small mt-1"><span id="summaryCount">0</span>/4000 Â· Markdown habilitado</div>',
      '</div>',
      '<div class="row g-3"><div class="col-md-6">',
      '<label class="eu-label" for="artCategory">CategorÃ­a</label>',
      '<select id="artCategory" class="eu-select"><option value="">Sin categorÃ­a</option>' + catOptions + '</select>',
      '</div></div>',
      '</div>',
      '<div class="eu-card p-4 mb-4">',
      '<div class="d-flex align-items-center justify-content-between mb-3 flex-wrap gap-2">',
      '<h5 class="m-0">Contenido del artÃ­culo</h5>',
      '<button class="eu-btn-outline eu-btn-sm" id="previewBtn" type="button" onclick="togglePreview()"><i class="bi bi-eye"></i> Vista previa</button>',
      '</div>',
      buildToolbar(),
      '<textarea id="artContent" class="eu-input eu-editor-area" style="border-radius:0 0 var(--eu-radius) var(--eu-radius);border-top:none" placeholder="# TÃ­tulo principal&#10;&#10;Escribe el contenido en Markdown..."></textarea>',
      '<div id="previewContainer" class="d-none mt-3">',
      '<div class="eu-label mb-2">Vista previa:</div>',
      '<div class="eu-preview-area eu-article-content p-3 border rounded" id="previewArea"></div>',
      '</div>',
      '</div>',
      '<div class="d-flex gap-3 justify-content-end flex-wrap">',
      '<a href="' + BASE + '/" class="eu-btn-outline">Cancelar</a>',
      '<button class="eu-btn-primary" type="button" id="publishBtn" onclick="publishArticle()"><i class="bi bi-send"></i> Enviar para revisiÃ³n</button>',
      '</div>',
      '</div>',
      '<div class="col-lg-4">',
      buildImagePanel(),
      buildSourcesPanel(),
      buildQuickRef(),
      '</div>',
      '</div>',
      '</div>'
    ].join('');

    document.getElementById('artSummary').addEventListener('input', function() {
      document.getElementById('summaryCount').textContent = this.value.length;
    });
    document.getElementById('artContent').addEventListener('keydown', handleEditorKeys);
  }

  function buildToolbar() {
    var btns = [
      {label:'<b>B</b>', fn:"insertMd('**','**')", title:'Negrita (Ctrl+B)'},
      {label:'<i>I</i>', fn:"insertMd('*','*')", title:'Cursiva (Ctrl+I)'},
      {label:'<s>S</s>', fn:"insertMd('~~','~~')", title:'Tachado'},
      {label:'<code style="font-size:.75rem">{ }</code>', fn:"insertMd('`','`')", title:'CÃ³digo inline'},
      {sep:true},
      {label:'H1', fn:"insertLine('# ')", title:'TÃ­tulo H1'},
      {label:'H2', fn:"insertLine('## ')", title:'TÃ­tulo H2'},
      {label:'H3', fn:"insertLine('### ')", title:'SubtÃ­tulo H3'},
      {label:'H4', fn:"insertLine('#### ')", title:'H4'},
      {sep:true},
      {label:'â€¢ Lista', fn:"insertLine('- ')", title:'Lista'},
      {label:'1. Lista', fn:"insertLine('1. ')", title:'Lista numerada'},
      {label:'â Cita', fn:"insertLine('> ')", title:'Cita'},
      {label:'â”€ HR', fn:"insertLine('---')", title:'LÃ­nea horizontal'},
      {sep:true},
      {label:'ğŸ”— Link', fn:'insertLink()', title:'Enlace (Ctrl+K)'},
      {label:'âŠ Tabla', fn:"insertSC('| Col1 | Col2 |\n|---|---|\n| valor | valor |')", title:'Tabla'},
      {sep:true},
      {label:'ğŸ’¬ Tooltip', fn:"insertSC('[tooltip text=\"DefiniciÃ³n\"]tÃ©rmino[/tooltip]')", title:'Tooltip'},
      {label:'âš ï¸ Alert', fn:"insertSC('[alert type=\"info\"]Mensaje[/alert]')", title:'Alerta'},
      {label:'ğŸ“Œ Callout', fn:"insertSC('[callout icon=\"ğŸ’¡\"]Nota[/callout]')", title:'Callout'},
      {label:'â–¶ AcordeÃ³n', fn:"insertSC('[accordion title=\"Â¿Pregunta?\"]\nRespuesta\n[/accordion]')", title:'AcordeÃ³n'},
      {label:'âŠŸ Tabs', fn:"insertSC('[tabs]\n[tab title=\"Tab 1\"]Contenido 1[/tab]\n[tab title=\"Tab 2\"]Contenido 2[/tab]\n[/tabs]')", title:'PestaÃ±as'},
      {label:'ğŸ–Š Resaltar', fn:"insertSC('[highlight]texto[/highlight]')", title:'Resaltar'},
      {label:'âˆ‘ FÃ³rmula', fn:"insertSC('[formula]E = mc^2[/formula]')", title:'FÃ³rmula'},
      {label:'â–¶ YouTube', fn:"insertSC('[youtube id=\"ID_VIDEO\"]')", title:'YouTube'},
      {label:'â†— Ref Art.', fn:"insertSC('[ref article=\"slug\"]texto[/ref]')", title:'Referencia artÃ­culo'},
      {label:'ğŸ—ºï¸ Mapa', fn:"insertSC('[mapa-sinoptico dir=\"LR\"]\nPadre -> Hijo1\nPadre -> Hijo2\nHijo1 -> Subhijo\n[/mapa-sinoptico]')", title:'Mapa SinÃ³ptico'},
      {label:'âš¡ Cuadro', fn:"insertSC('[cuadro-sinoptico main=\"TÃ­tulo\"]\n[etapa title=\"ETAPA 1\" color=\"#3b82f6\"]DescripciÃ³n[/etapa]\n[/cuadro-sinoptico]')", title:'Cuadro sinÃ³ptico'},
      {label:'ğŸƒ Card', fn:"insertSC('[card title=\"TÃ­tulo\"]Contenido[/card]')", title:'Tarjeta'},
      {label:'â¬œ Modal', fn:"insertSC('[modal id=\"m1\" title=\"Modal\"]Contenido[/modal]\n[modal-trigger modal=\"m1\"]Abrir[/modal-trigger]')", title:'Modal'},
    ];
    return '<div class="eu-editor-toolbar" id="editorToolbar">' +
      btns.map(function(b){ return b.sep
        ? '<div class="eu-editor-separator"></div>'
        : '<button type="button" class="eu-editor-btn" onclick="' + b.fn + '" title="' + b.title + '">' + b.label + '</button>';
      }).join('') + '</div>';
  }

  function buildImagePanel() {
    return [
      '<div class="eu-card p-4 mb-4" id="imagePanel">',
      '<h5 class="mb-1"><i class="bi bi-images me-2"></i>Multimedia</h5>',
      '<p class="text-muted small mb-3">ImÃ¡genes en borrador hasta aprobaciÃ³n del artÃ­culo.</p>',
      '<div id="uploadArea" class="eu-upload-zone mb-3"',
      ' ondragover="event.preventDefault();this.classList.add(\'dragover\')"',
      ' ondragleave="this.classList.remove(\'dragover\')"',
      ' ondrop="handleDrop(event)">',
      '<i class="bi bi-cloud-upload fs-3 mb-2 d-block text-muted"></i>',
      '<div class="small text-muted mb-2">Arrastra imÃ¡genes aquÃ­ o</div>',
      '<label for="imageInput" class="eu-btn-outline eu-btn-sm" style="cursor:pointer"><i class="bi bi-plus-circle"></i> Seleccionar</label>',
      '<input type="file" id="imageInput" multiple accept="image/*" class="d-none" onchange="uploadImages(this.files)">',
      '<div class="text-muted mt-2" style="font-size:.7rem">PNG, JPG, GIF, WebP Â· MÃ¡x 5MB</div>',
      '</div>',
      '<div id="imgUploadProgress" class="d-none mb-3">',
      '<div class="eu-progress-bar-wrap"><div id="imgProgressBar" class="eu-progress-bar" style="width:0%"></div></div>',
      '<div class="small text-muted mt-1" id="imgProgressLabel">Subiendo...</div>',
      '</div>',
      '<div id="uploadedImages" class="eu-media-grid"></div>',
      '</div>'
    ].join('');
  }

  function buildSourcesPanel() {
    return [
      '<div class="eu-card p-4 mb-4" id="sourcesPanel">',
      '<h5 class="mb-1"><i class="bi bi-link-45deg me-2"></i>Fuentes</h5>',
      '<p class="text-muted small mb-3">AparecerÃ¡n en el sidebar del artÃ­culo publicado.</p>',
      '<div class="mb-3 pb-3" style="border-bottom:1px solid var(--eu-border)">',
      '<div class="fw-semibold small mb-2">ğŸ”— AÃ±adir enlace</div>',
      '<input type="text" id="srcLinkTitle" class="eu-input mb-2" placeholder="TÃ­tulo (ej: Wikipedia - FotosÃ­ntesis)">',
      '<input type="url" id="srcLinkUrl" class="eu-input mb-2" placeholder="https://...">',
      '<button type="button" class="eu-btn-outline eu-btn-sm w-100" onclick="addLinkSource()"><i class="bi bi-plus-circle"></i> AÃ±adir enlace</button>',
      '</div>',
      '<div class="mb-3">',
      '<div class="fw-semibold small mb-2">ğŸ“„ AÃ±adir PDF</div>',
      '<input type="text" id="srcPdfTitle" class="eu-input mb-2" placeholder="TÃ­tulo del PDF (opcional)">',
      '<div id="pdfAttachZone">',
      '<label class="eu-btn-outline eu-btn-sm w-100 text-center" style="cursor:pointer">',
      '<i class="bi bi-paperclip"></i> Adjuntar PDF (mÃ¡x 10MB)',
      '<input type="file" id="srcPdfInput" accept=".pdf" class="d-none" onchange="attachPdf(this)">',
      '</label>',
      '</div>',
      '<div id="pdfPreview" class="d-none mt-2 p-2 rounded d-flex align-items-center gap-2" style="background:var(--eu-bg-secondary);border:1px solid var(--eu-border)">',
      '<svg viewBox="0 0 24 24" fill="currentColor" style="width:16px;height:16px;flex-shrink:0;color:#dc2626"><path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/></svg>',
      '<span class="small" id="pdfPreviewName" style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap"></span>',
      '<button type="button" class="eu-source-delete-btn" onclick="clearPdfAttach()" title="Quitar">âœ•</button>',
      '</div>',
      '<button type="button" class="eu-btn-primary eu-btn-sm w-100 mt-2 d-none" id="addPdfBtn" onclick="addPdfSource()"><i class="bi bi-plus-circle"></i> AÃ±adir PDF</button>',
      '</div>',
      '<div id="sourcesMsg"></div>',
      '<div id="sourcesList" class="eu-sources-editor mt-2">',
      '<div class="text-muted text-center p-3 small">No hay fuentes aÃºn</div>',
      '</div>',
      '</div>'
    ].join('');
  }

  function buildQuickRef() {
    return [
      '<div class="eu-card p-4">',
      '<h5 class="mb-3"><i class="bi bi-question-circle me-2"></i>Referencia rÃ¡pida</h5>',
      '<div style="font-size:.78rem;line-height:1.9;font-family:monospace;color:var(--eu-text-secondary)">',
      '<div>**negrita** / *cursiva* / ~~tachado~~</div>',
      '<div># H1 / ## H2 / ### H3</div>',
      '<div>- Lista Â· 1. Numerada</div>',
      '<div>&gt; Cita en bloque</div>',
      '<div>[texto](url)</div>',
      '<div class="mt-2 pt-2" style="border-top:1px solid var(--eu-border)">ğŸ—ºï¸ Mapa SinÃ³ptico:</div>',
      '<div>[mapa-sinoptico dir="LR"]</div>',
      '<div>A -> B Â· B -> C</div>',
      '<div>[/mapa-sinoptico]</div>',
      '</div>',
      '<a href="' + BASE + '/shortcodes.html" class="eu-btn-outline eu-btn-sm w-100 mt-3 text-center">Ver guÃ­a completa</a>',
      '</div>'
    ].join('');
  }

  // â”€â”€ SUMMARY HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  window.summaryWrap = function(before, after) {
    var ta = document.getElementById('artSummary');
    var s = ta.selectionStart, e = ta.selectionEnd;
    var sel = ta.value.substring(s, e) || 'texto';
    var st = ta.scrollTop;
    ta.value = ta.value.substring(0, s) + before + sel + after + ta.value.substring(e);
    ta.selectionStart = s + before.length;
    ta.selectionEnd = s + before.length + sel.length;
    ta.scrollTop = st;
    ta.focus();
  };
  window.summaryLine = function(prefix) {
    var ta = document.getElementById('artSummary');
    var s = ta.selectionStart;
    var start = ta.value.lastIndexOf('\n', s - 1) + 1;
    var st = ta.scrollTop;
    ta.value = ta.value.substring(0, start) + prefix + ta.value.substring(start);
    ta.selectionStart = ta.selectionEnd = start + prefix.length;
    ta.scrollTop = st;
    ta.focus();
  };
  window.summaryAnchor = function() {
    var id = prompt('ID del tÃ­tulo (ej: "metabolismo" para "## Metabolismo"):');
    if (!id) return;
    var label = prompt('Texto del enlace:') || id;
    var ta = document.getElementById('artSummary');
    var pos = ta.selectionStart;
    var st = ta.scrollTop;
    var ins = '[' + label + '](#' + id + ')';
    ta.value = ta.value.slice(0, pos) + ins + ta.value.slice(pos);
    ta.scrollTop = st;
    ta.focus();
  };

  // â”€â”€ CONTENT EDITOR HELPERS â€” NO SCROLL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function noScrollInsert(ta, text, from, to) {
    var pageY = window.scrollY;
    var taTop = ta.scrollTop;
    ta.value = ta.value.slice(0, from) + text + ta.value.slice(to);
    ta.scrollTop = taTop;
    window.scrollTo({ top: pageY });
  }

  window.insertMd = function(before, after) {
    var ta = document.getElementById('artContent');
    var s = ta.selectionStart, e = ta.selectionEnd;
    var sel = ta.value.slice(s, e) || 'texto';
    noScrollInsert(ta, before + sel + after, s, e);
    ta.focus();
    ta.setSelectionRange(s + before.length, s + before.length + sel.length);
  };
  window.insertLine = function(prefix) {
    var ta = document.getElementById('artContent');
    var s = ta.selectionStart;
    var start = ta.value.lastIndexOf('\n', s - 1) + 1;
    noScrollInsert(ta, prefix, start, start);
    ta.focus();
    ta.setSelectionRange(start + prefix.length, start + prefix.length);
  };
  window.insertSC = function(sc) {
    var ta = document.getElementById('artContent');
    var pos = ta.selectionStart;
    noScrollInsert(ta, '\n' + sc + '\n', pos, pos);
    ta.focus();
    ta.setSelectionRange(pos + 1, pos + 1 + sc.length);
  };
  window.insertLink = function() {
    var url = prompt('URL del enlace:');
    if (!url) return;
    var label = prompt('Texto del enlace:') || url;
    var ta = document.getElementById('artContent');
    var pos = ta.selectionStart;
    noScrollInsert(ta, '[' + label + '](' + url + ')', pos, pos);
    ta.focus();
  };
  window.insertImageShortcode = function(url, alt) {
    var ta = document.getElementById('artContent');
    var pos = ta.selectionStart;
    noScrollInsert(ta, '\n[img file="' + url + '" alt="' + alt + '" caption=""]\n', pos, pos);
    ta.focus();
    window.showToast('Imagen insertada', 'success');
  };

  function handleEditorKeys(e) {
    if (e.ctrlKey || e.metaKey) {
      if (e.key === 'b') { e.preventDefault(); insertMd('**','**'); }
      if (e.key === 'i') { e.preventDefault(); insertMd('*','*'); }
      if (e.key === 'k') { e.preventDefault(); insertLink(); }
    }
    if (e.key === 'Tab') {
      e.preventDefault();
      var ta = e.target;
      var s = ta.selectionStart;
      var st = ta.scrollTop;
      ta.value = ta.value.slice(0, s) + '  ' + ta.value.slice(s);
      ta.selectionStart = ta.selectionEnd = s + 2;
      ta.scrollTop = st;
    }
  }

  // â”€â”€ PREVIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  window.togglePreview = function() {
    var container = document.getElementById('previewContainer');
    var area = document.getElementById('previewArea');
    var content = document.getElementById('artContent').value;
    if (container.classList.contains('d-none')) {
      container.classList.remove('d-none');
      area.innerHTML = simplePreview(content);
      document.getElementById('previewBtn').innerHTML = '<i class="bi bi-pencil"></i> Editar';
    } else {
      container.classList.add('d-none');
      document.getElementById('previewBtn').innerHTML = '<i class="bi bi-eye"></i> Vista previa';
    }
  };
  function simplePreview(md) {
    return md
      .replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>')
      .replace(/\*(.*?)\*/g,'<em>$1</em>')
      .replace(/~~(.*?)~~/g,'<s>$1</s>')
      .replace(/^#### (.*)/gm,'<h4>$1</h4>')
      .replace(/^### (.*)/gm,'<h3>$1</h3>')
      .replace(/^## (.*)/gm,'<h2>$1</h2>')
      .replace(/^# (.*)/gm,'<h1>$1</h1>')
      .replace(/^- (.*)/gm,'<li>$1</li>')
      .replace(/\[([^\]]+)\]\(([^)]+)\)/g,'<a href="$2">$1</a>')
      .replace(/`([^`]+)`/g,'<code>$1</code>')
      .replace(/\[\/?\w[^\]]*\]/g,'<span style="opacity:.5;font-style:italic">[shortcode]</span>')
      .replace(/\n/g,'<br>');
  }

  // â”€â”€ IMAGE UPLOAD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  window.uploadImages = async function(files) {
    var formData = new FormData();
    for (var i = 0; i < files.length; i++) formData.append('images', files[i]);
    if (articleId) formData.append('articleId', articleId);

    var prog = document.getElementById('imgUploadProgress');
    var bar = document.getElementById('imgProgressBar');
    var lbl = document.getElementById('imgProgressLabel');
    prog.classList.remove('d-none');
    bar.style.width = '15%';
    bar.style.background = '';
    lbl.textContent = 'Subiendo ' + files.length + ' imagen(es)...';

    var token = Auth.getToken();
    var ticker = setInterval(function(){ bar.style.width = Math.min(parseFloat(bar.style.width)+7, 80) + '%'; }, 300);
    try {
      var res = await fetch(API + '/api/media/upload', {
        method: 'POST',
        headers: { Authorization: 'Bearer ' + token },
        body: formData
      });
      clearInterval(ticker);
      bar.style.width = '100%';
      var data = await res.json();
      if (!res.ok) throw new Error(data.error);

      lbl.textContent = 'âœ“ ' + data.files.length + ' imagen(es) lista(s)';
      setTimeout(function(){ prog.classList.add('d-none'); }, 2500);

      var container = document.getElementById('uploadedImages');
      data.files.forEach(function(f) {
        appendImageThumb(container, f.id, f.publicUrl, f.filename);
      });
      window.showToast(data.files.length + ' imagen(es) subida(s)', 'success');
    } catch(err) {
      clearInterval(ticker);
      bar.style.width = '100%';
      bar.style.background = 'var(--eu-danger)';
      lbl.textContent = 'âœ— ' + err.message;
      setTimeout(function(){ prog.classList.add('d-none'); bar.style.background = ''; }, 3500);
      window.showToast(err.message, 'error');
    }
  };

  function appendImageThumb(container, mediaId, url, filename) {
    var altName = filename.replace(/\.[^.]+$/, '');
    var div = document.createElement('div');
    div.className = 'eu-media-thumb';
    div.dataset.mediaId = mediaId;
    div.innerHTML =
      '<img src="' + escHtml(url) + '" alt="' + escHtml(filename) + '" loading="lazy">' +
      '<div class="eu-media-thumb-overlay">' +
      '<button type="button" onclick="insertImageShortcode(\'' + escAttr(url) + '\',\'' + escAttr(altName) + '\')">ğŸ“¥ Insertar</button>' +
      '<button type="button" onclick="deleteImage(' + mediaId + ', this)" style="color:#fca5a5">ğŸ—‘ Eliminar</button>' +
      '</div>';
    container.appendChild(div);
  }

  window.deleteImage = async function(mediaId, btn) {
    if (!confirm('Â¿Eliminar esta imagen? No se puede deshacer.')) return;
    var token = Auth.getToken();
    btn.disabled = true;
    btn.textContent = '...';
    try {
      var res = await fetch(API + '/api/media/' + mediaId, {
        method: 'DELETE',
        headers: { Authorization: 'Bearer ' + token }
      });
      if (!res.ok) { var d = await res.json(); throw new Error(d.error); }
      var thumb = btn.closest('.eu-media-thumb');
      if (thumb) { thumb.style.transition = 'opacity .3s'; thumb.style.opacity = '0'; setTimeout(function(){ thumb.remove(); }, 300); }
      window.showToast('Imagen eliminada', 'success');
    } catch(err) {
      window.showToast('Error: ' + err.message, 'error');
      btn.disabled = false;
      btn.textContent = 'ğŸ—‘ Eliminar';
    }
  };

  window.handleDrop = function(e) {
    e.preventDefault();
    document.getElementById('uploadArea').classList.remove('dragover');
    if (e.dataTransfer.files.length) uploadImages(e.dataTransfer.files);
  };

  // â”€â”€ SOURCES â€” ATTACH & STAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  window.attachPdf = function(input) {
    var file = input.files[0];
    if (!file) return;
    if (file.size > 10 * 1024 * 1024) { showSourceMsg('warning', 'El PDF supera los 10MB'); input.value = ''; return; }
    pendingPdf = { file: file, name: file.name };
    var title = document.getElementById('srcPdfTitle').value.trim() || file.name.replace(/\.pdf$/i,'');
    document.getElementById('srcPdfTitle').value = title;
    document.getElementById('pdfPreviewName').textContent = file.name + ' (' + fmtSize(file.size) + ')';
    document.getElementById('pdfPreview').classList.remove('d-none');
    document.getElementById('addPdfBtn').classList.remove('d-none');
    document.getElementById('pdfAttachZone').classList.add('d-none');
  };

  window.clearPdfAttach = function() {
    pendingPdf = null;
    document.getElementById('srcPdfInput').value = '';
    document.getElementById('pdfPreview').classList.add('d-none');
    document.getElementById('addPdfBtn').classList.add('d-none');
    document.getElementById('pdfAttachZone').classList.remove('d-none');
  };

  window.addPdfSource = function() {
    if (!pendingPdf) return;
    var title = document.getElementById('srcPdfTitle').value.trim() || pendingPdf.name.replace(/\.pdf$/i,'');
    if (localSources.filter(function(s){return s.type==='pdf';}).length >= 5) { showSourceMsg('warning','LÃ­mite de 5 PDFs alcanzado'); return; }
    localSources.push({ id: Date.now(), type: 'pdf', title: title, file: pendingPdf.file, fileName: pendingPdf.name });
    renderLocalSources();
    document.getElementById('srcPdfTitle').value = '';
    clearPdfAttach();
    showSourceMsg('success', 'ğŸ“„ PDF listo â€” se subirÃ¡ al publicar');
  };

  window.addLinkSource = function() {
    var title = document.getElementById('srcLinkTitle').value.trim();
    var url = document.getElementById('srcLinkUrl').value.trim();
    if (!title || !url) { showSourceMsg('warning','TÃ­tulo y URL son obligatorios'); return; }
    try { new URL(url); } catch(e) { showSourceMsg('warning','URL invÃ¡lida'); return; }
    if (localSources.filter(function(s){return s.type==='link';}).length >= 20) { showSourceMsg('warning','LÃ­mite de 20 enlaces'); return; }
    localSources.push({ id: Date.now(), type: 'link', title: title, url: url });
    renderLocalSources();
    document.getElementById('srcLinkTitle').value = '';
    document.getElementById('srcLinkUrl').value = '';
    showSourceMsg('success', 'ğŸ”— Enlace aÃ±adido');
  };

  function showSourceMsg(type, msg) {
    var el = document.getElementById('sourcesMsg');
    el.innerHTML = '<div class="alert alert-' + type + ' py-2 px-3 small mb-0">' + escHtml(msg) + '</div>';
    setTimeout(function(){ if(el) el.innerHTML=''; }, 3500);
  }

  function renderLocalSources() {
    var container = document.getElementById('sourcesList');
    if (!localSources.length) {
      container.innerHTML = '<div class="text-muted text-center p-3 small">No hay fuentes aÃºn</div>';
      return;
    }
    container.innerHTML = localSources.map(function(s) {
      var icon = s.type === 'pdf'
        ? '<svg viewBox="0 0 24 24" fill="currentColor" style="width:16px;height:16px;flex-shrink:0;color:#dc2626"><path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/></svg>'
        : '<i class="bi bi-link-45deg" style="flex-shrink:0"></i>';
      return '<div class="eu-source-editor-item" id="lsrc-' + s.id + '">' +
        icon +
        '<span class="eu-source-title" title="' + escHtml(s.title) + '">' + escHtml(s.title) + '</span>' +
        '<button type="button" class="eu-source-action-btn" onclick="editLocalSource(' + s.id + ')" title="Editar">âœï¸</button>' +
        '<button type="button" class="eu-source-insert-btn" onclick="insertSourceRef(' + s.id + ')">Citar</button>' +
        '<button type="button" class="eu-source-delete-btn" onclick="removeLocalSource(' + s.id + ')">âœ•</button>' +
        '</div>';
    }).join('');
  }

  window.editLocalSource = function(id) {
    var src = localSources.find(function(s){return s.id===id;});
    if (!src) return;
    var newTitle = prompt('TÃ­tulo:', src.title);
    if (newTitle === null) return;
    if (newTitle.trim()) src.title = newTitle.trim();
    if (src.type === 'link') {
      var newUrl = prompt('URL:', src.url);
      if (newUrl !== null && newUrl.trim()) {
        try { new URL(newUrl.trim()); src.url = newUrl.trim(); } catch(e) { window.showToast('URL invÃ¡lida','error'); return; }
      }
    }
    renderLocalSources();
  };

  window.insertSourceRef = function(id) {
    var src = localSources.find(function(s){return s.id===id;});
    if (!src) return;
    var ta = document.getElementById('artContent');
    var pos = ta.selectionStart;
    noScrollInsert(ta, '[source-ref title="' + escAttr(src.title) + '"]', pos, pos);
    ta.focus();
    window.showToast('Referencia insertada','success');
  };

  window.removeLocalSource = function(id) {
    localSources = localSources.filter(function(s){return s.id!==id;});
    renderLocalSources();
  };

  // â”€â”€ PUBLISH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  window.publishArticle = async function() {
    var title = document.getElementById('artTitle').value.trim();
    var summary = document.getElementById('artSummary').value.trim();
    var content = document.getElementById('artContent').value.trim();
    var category = document.getElementById('artCategory').value;
    var btn = document.getElementById('publishBtn');
    var alertEl = document.getElementById('publishAlert');

    if (!title || !summary || !content) {
      alertEl.className = 'alert alert-danger';
      alertEl.textContent = 'El tÃ­tulo, resumen y contenido son obligatorios';
      alertEl.classList.remove('d-none');
      window.scrollTo({ top: 0, behavior: 'smooth' });
      return;
    }
    btn.disabled = true;
    btn.innerHTML = '<span class="eu-spinner" style="width:18px;height:18px;border-width:2px"></span> Enviando...';
    alertEl.classList.add('d-none');

    try {
      var res = await Auth.authFetch(API + '/api/articles', {
        method: 'POST',
        body: JSON.stringify({ title: title, summary: summary, content: content, category: category })
      });
      var data = await res.json();
      if (!res.ok) throw new Error(data.error);
      articleId = data.articleId;

      if (localSources.length) await uploadPendingSources(articleId);

      alertEl.className = 'alert alert-success';
      alertEl.innerHTML = 'âœ“ <strong>ArtÃ­culo enviado.</strong> QuedarÃ¡ visible cuando un moderador lo apruebe. <a href="' + BASE + '/articulo.html?slug=' + data.slug + '" class="alert-link">Ver artÃ­culo</a>';
      alertEl.classList.remove('d-none');
      btn.innerHTML = '<i class="bi bi-check-lg"></i> Enviado';
      window.scrollTo({ top: 0, behavior: 'smooth' });
    } catch(err) {
      alertEl.className = 'alert alert-danger';
      alertEl.textContent = err.message;
      alertEl.classList.remove('d-none');
      btn.disabled = false;
      btn.innerHTML = '<i class="bi bi-send"></i> Enviar para revisiÃ³n';
    }
  };

  async function uploadPendingSources(artId) {
    var token = Auth.getToken();
    for (var i = 0; i < localSources.length; i++) {
      var src = localSources[i];
      try {
        if (src.type === 'link') {
          await fetch(API + '/api/articles/' + artId + '/sources', {
            method: 'POST',
            headers: { 'Content-Type':'application/json', 'Authorization':'Bearer ' + token },
            body: JSON.stringify({ type:'link', title:src.title, url:src.url })
          });
        } else if (src.type === 'pdf') {
          var fd = new FormData();
          fd.append('pdf', src.file);
          fd.append('title', src.title);
          await fetch(API + '/api/articles/' + artId + '/sources/pdf', {
            method: 'POST',
            headers: { 'Authorization':'Bearer ' + token },
            body: fd
          });
        }
      } catch(e) { console.warn('Source failed:', e); }
    }
  }

  function fmtSize(bytes) {
    var k = 1024, s = ['B','KB','MB'];
    var i = Math.floor(Math.log(bytes) / Math.log(k));
    return (bytes / Math.pow(k, i)).toFixed(1) + ' ' + s[i];
  }
  function noScrollInsert(ta, text, from, to) {
    var pageY = window.scrollY, taTop = ta.scrollTop;
    ta.value = ta.value.slice(0, from) + text + ta.value.slice(to);
    ta.scrollTop = taTop;
    window.scrollTo({ top: pageY });
  }
  function escHtml(s) { return String(s||'').replace(/[&<>"']/g,function(c){return({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]);}); }
  function escAttr(s) { return escHtml(s); }
})();
</script>
