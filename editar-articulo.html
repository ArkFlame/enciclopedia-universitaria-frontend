---
layout: default
title: Editar art√≠culo
---

<div id="editorPage" style="max-width:1200px;margin:0 auto;padding:32px 20px">
  <div class="eu-loading" style="min-height:50vh">
    <div class="eu-spinner"></div>
    <span>Cargando art√≠culo...</span>
  </div>
</div>

<style>
.eu-editor-textarea {
  font-family: 'Courier New', Courier, monospace;
  font-size: .88rem;
  line-height: 1.7;
  resize: vertical;
  min-height: 450px;
  border-radius: 0 0 var(--eu-radius) var(--eu-radius) !important;
  border-top: none !important;
}
</style>

<script>
(function() {
  var API    = window.EU_CONFIG.backendUrl;
  var BASE   = window.EU_CONFIG.baseUrl;
  var params = new URLSearchParams(window.location.search);
  var slug   = params.get('slug');
  var idParam = params.get('id');
  var articleData = null;
  var existingSources = [];
  var pendingPdf = null;

  document.addEventListener('DOMContentLoaded', async function() {
    await new Promise(function(r){ setTimeout(r, 100); });
    if (!Auth.isLoggedIn()) {
      window.location.href = BASE + '/login.html?redirect=' + encodeURIComponent(window.location.href);
      return;
    }
    if (!slug && !idParam) { renderError('No se especific√≥ el art√≠culo a editar.'); return; }
    await loadArticle();
  });

  async function loadArticle() {
    try {
      if (slug) {
        var res = await fetch(API + '/api/articles/' + encodeURIComponent(slug) + '?includePending=true');
        if (!res.ok) { var err = await res.json().catch(function(){return{};}); throw new Error(err.error || 'Error al cargar'); }
        articleData = await res.json();
      } else {
        throw new Error('Se requiere el slug del art√≠culo.');
      }

      var rawContent = '';
      var contentRes = await Auth.authFetch(API + '/api/articles/by-id/' + articleData.id + '/content');
      if (contentRes && contentRes.ok) {
        var cd = await contentRes.json();
        rawContent = cd.content || '';
      }

      try {
        var srcRes = await fetch(API + '/api/articles/' + articleData.id + '/sources');
        if (srcRes.ok) {
          var srcData = await srcRes.json();
          existingSources = [].concat(srcData.pdfs || [], srcData.links || []);
        }
      } catch(e) {}

      renderEditor(articleData, rawContent);
    } catch(e) {
      renderError(e.message);
    }
  }

  function buildToolbar() {
    var btns = [
      {label:'<b>B</b>', fn:"wrap('**','**')", title:'Negrita (Ctrl+B)'},
      {label:'<i>I</i>', fn:"wrap('*','*')", title:'Cursiva (Ctrl+I)'},
      {label:'<s>S</s>', fn:"wrap('~~','~~')", title:'Tachado'},
      {label:'<code style="font-size:.75rem">{ }</code>', fn:"wrap('`','`')", title:'C√≥digo'},
      {sep:true},
      {label:'H1', fn:"insertLine('# ')", title:'H1'},
      {label:'H2', fn:"insertLine('## ')", title:'H2'},
      {label:'H3', fn:"insertLine('### ')", title:'H3'},
      {sep:true},
      {label:'‚Ä¢ Lista', fn:"insertLine('- ')", title:'Lista'},
      {label:'1. Lista', fn:"insertLine('1. ')", title:'Numerada'},
      {label:'‚ùù Cita', fn:"insertLine('> ')", title:'Cita'},
      {label:'‚îÄ HR', fn:"insertLine('---')", title:'HR'},
      {sep:true},
      {label:'üîó Link', fn:'insertLinkEdit()', title:'Enlace (Ctrl+K)'},
      {label:'‚äû Tabla', fn:"insertSCEdit('| Col1 | Col2 |\n|---|---|\n| valor | valor |')", title:'Tabla'},
      {sep:true},
      {label:'üí¨ Tooltip', fn:"insertSCEdit('[tooltip text=\"Def\"]t√©rmino[/tooltip]')", title:'Tooltip'},
      {label:'‚ö†Ô∏è Alert', fn:"insertSCEdit('[alert type=\"info\"]Mensaje[/alert]')", title:'Alert'},
      {label:'üìå Callout', fn:"insertSCEdit('[callout icon=\"üí°\"]Nota[/callout]')", title:'Callout'},
      {label:'‚ñ∂ Acorde√≥n', fn:"insertSCEdit('[accordion title=\"T√≠tulo\"]\nContenido\n[/accordion]')", title:'Acorde√≥n'},
      {label:'‚äü Tabs', fn:"insertSCEdit('[tabs]\n[tab title=\"Tab 1\"]Contenido 1[/tab]\n[tab title=\"Tab 2\"]Contenido 2[/tab]\n[/tabs]')", title:'Tabs'},
      {label:'üñä Resaltar', fn:"insertSCEdit('[highlight]texto[/highlight]')", title:'Resaltar'},
      {label:'‚àë F√≥rmula', fn:"insertSCEdit('[formula]E = mc^2[/formula]')", title:'F√≥rmula'},
      {label:'‚ñ∂ YouTube', fn:"insertSCEdit('[youtube id=\"ID_VIDEO\"]')", title:'YouTube'},
      {label:'‚Üó Ref', fn:"insertSCEdit('[ref article=\"slug\"]texto[/ref]')", title:'Referencia'},
      {label:'üó∫Ô∏è √Årbol', fn:"insertSCEdit('[mapa-sinoptico name=\"Mapa Conceptual\"]\\nC√©lula -> Eucariota\\nEucariota -> Animal\\nEucariota -> Vegetal\\nC√©lula -> Procariota\\nProcariota -> Bacteria\\nProcariota -> Archaea\\n[/mapa-sinoptico]')", title:'Mapa Conceptual (Mapa Sin√≥ptico)'},
      {label:'‚ö° Cuadro', fn:"insertSCEdit('[cuadro-sinoptico main=\"T√≠tulo\"]\n[etapa title=\"ETAPA 1\" color=\"#3b82f6\"]Desc[/etapa]\n[/cuadro-sinoptico]')", title:'Cuadro sin√≥ptico'},
    ];
    return '<div class="eu-editor-toolbar">' +
      btns.map(function(b){ return b.sep
        ? '<div class="eu-editor-separator"></div>'
        : '<button type="button" class="eu-editor-btn" onclick="' + b.fn + '" title="' + b.title + '">' + b.label + '</button>';
      }).join('') + '</div>';
  }

  function renderEditor(article, rawContent) {
    var sourcesHtml = buildSourcesPanel(article);
    var imagesPanelHtml = buildImagesPanel(article);

    document.getElementById('editorPage').innerHTML = [
      '<div class="d-flex align-items-center gap-3 mb-4 flex-wrap">',
      '<a href="' + BASE + '/articulo.html?slug=' + encodeURIComponent(article.slug) + '" class="eu-btn-outline btn-sm"><i class="bi bi-arrow-left"></i> Volver</a>',
      '<div style="flex:1;min-width:0"><div class="text-muted small">Proponiendo edici√≥n para:</div>',
      '<h1 style="font-family:var(--eu-font-display);font-size:1.3rem;margin:0" class="text-truncate">' + escHtml(article.title) + '</h1></div>',
      '</div>',

      '<div class="alert alert-info d-flex gap-2 align-items-start mb-4">',
      '<i class="bi bi-info-circle flex-shrink-0 mt-1"></i>',
      '<div>Tu edici√≥n quedar√° <strong>pendiente de aprobaci√≥n</strong>. El art√≠culo original no cambia hasta que sea aprobada.' +
      '<br><small>Las im√°genes y fuentes que agregues se guardan en un √°rea de revisi√≥n hasta ser aprobadas.</small></div>',
      '</div>',

      '<div id="submitMsg"></div>',

      '<div class="row g-4">',
      '<div class="col-lg-8">',
      '<div class="eu-card p-4 mb-4">',
      '<h4 style="font-size:1rem;font-weight:700;margin-bottom:20px">Tu propuesta de edici√≥n</h4>',

      '<div class="mb-3">',
      '<label class="eu-label">T√≠tulo <span class="text-muted fw-normal small">‚Äî dejar igual si no cambia</span></label>',
      '<input type="text" id="editTitle" class="eu-input" value="' + escHtml(article.title) + '" maxlength="500">',
      '</div>',

      '<div class="mb-3">',
      '<label class="eu-label">Resumen <span class="text-muted fw-normal small">‚Äî Markdown habilitado</span></label>',
      '<div class="eu-summary-toolbar">',
      '<button class="eu-editor-btn" type="button" onclick="summaryWrapEdit(\'**\',\'**\')"><b>B</b></button>',
      '<button class="eu-editor-btn" type="button" onclick="summaryWrapEdit(\'*\',\'*\')"><i>I</i></button>',
      '<button class="eu-editor-btn" type="button" onclick="summaryLineEdit(\'- \')">‚Ä¢ Lista</button>',
      '<button class="eu-editor-btn" type="button" onclick="summaryLineEdit(\'1. \')">1. Lista</button>',
      '<button class="eu-editor-btn" type="button" onclick="summaryAnchorEdit()">‚öì Secci√≥n</button>',
      '</div>',
      '<textarea id="editSummary" class="eu-input eu-summary-textarea" rows="4" maxlength="4000">' + escHtml(article.summary) + '</textarea>',
      '</div>',

      '<div class="mb-3">',
      '<label class="eu-label">Contenido completo <span class="text-danger">*</span></label>',
      buildToolbar(),
      '<textarea id="editContent" class="eu-input eu-editor-textarea" spellcheck="true">' + escHtml(rawContent) + '</textarea>',
      '<div class="d-flex justify-content-between mt-1">',
      '<span class="text-muted small">Ctrl+B negrita ¬∑ Ctrl+I cursiva ¬∑ <a href="' + BASE + '/shortcodes.html" target="_blank">Gu√≠a shortcodes</a></span>',
      '<span class="text-muted small" id="charCount">0 car.</span>',
      '</div>',
      '</div>',

      '<div class="mb-4">',
      '<label class="eu-label">Nota para moderadores <span class="text-muted fw-normal small">(opcional)</span></label>',
      '<textarea id="editNote" class="eu-input" rows="2" maxlength="1000" placeholder="Ej: Correg√≠ el tercer p√°rrafo con datos actualizados."></textarea>',
      '</div>',

      '<div class="d-flex gap-3 align-items-center flex-wrap">',
      '<button id="submitBtn" type="button" class="eu-btn-primary" onclick="submitEdit(' + article.id + ')">',
      '<i class="bi bi-send me-1"></i> Enviar edici√≥n para revisi√≥n</button>',
      '<a href="' + BASE + '/articulo.html?slug=' + encodeURIComponent(article.slug) + '" class="eu-btn-outline">Cancelar</a>',
      '<div id="submitSpinner" class="d-none"><div class="eu-spinner" style="width:20px;height:20px"></div></div>',
      '</div>',
      '</div>',

      rawContent ? '<details class="eu-card p-4 mt-4"><summary style="cursor:pointer;font-weight:600;font-size:.9rem"><i class="bi bi-file-earmark-text me-2"></i>Ver original (referencia)</summary><div class="mt-3" style="background:var(--eu-bg-secondary);padding:14px;border-radius:var(--eu-radius);max-height:350px;overflow-y:auto"><pre style="font-size:.78rem;white-space:pre-wrap;word-break:break-word;margin:0;font-family:Courier New,monospace">' + escHtml(rawContent) + '</pre></div></details>' : '',

      '</div>',

      '<div class="col-lg-4">',
      imagesPanelHtml,
      sourcesHtml,
      '</div>',
      '</div>'
    ].join('');

    var ta = document.getElementById('editContent');
    var cc = document.getElementById('charCount');
    function updateCount() { cc.textContent = ta.value.length.toLocaleString('es-AR') + ' car.'; }
    ta.addEventListener('input', updateCount);
    updateCount();

    ta.addEventListener('keydown', function(e) {
      if (e.ctrlKey || e.metaKey) {
        if (e.key === 'b') { e.preventDefault(); wrap('**','**'); }
        if (e.key === 'i') { e.preventDefault(); wrap('*','*'); }
        if (e.key === 'k') { e.preventDefault(); insertLinkEdit(); }
      }
      if (e.key === 'Tab') {
        e.preventDefault();
        var s = ta.selectionStart;
        var st = ta.scrollTop;
        ta.value = ta.value.slice(0, s) + '  ' + ta.value.slice(s);
        ta.selectionStart = ta.selectionEnd = s + 2;
        ta.scrollTop = st;
      }
    });

    loadExistingImages(article.id);
  }

  function buildImagesPanel(article) {
    return [
      '<div class="eu-card p-4 mb-4">',
      '<h5 class="mb-1"><i class="bi bi-images me-2"></i>Multimedia</h5>',
      '<p class="text-muted small mb-3">Im√°genes en √°rea de revisi√≥n hasta aprobaci√≥n.</p>',
      '<div id="editUploadArea" class="eu-upload-zone mb-3"',
      ' ondragover="event.preventDefault();this.classList.add(\'dragover\')"',
      ' ondragleave="this.classList.remove(\'dragover\')"',
      ' ondrop="handleEditDrop(event)">',
      '<i class="bi bi-cloud-upload fs-3 mb-2 d-block text-muted"></i>',
      '<label for="editImageInput" class="eu-btn-outline eu-btn-sm" style="cursor:pointer"><i class="bi bi-plus-circle"></i> Subir im√°genes</label>',
      '<input type="file" id="editImageInput" multiple accept="image/*" class="d-none" onchange="uploadEditImages(this.files)">',
      '<div class="text-muted mt-1" style="font-size:.7rem">PNG, JPG, WebP ¬∑ M√°x 5MB</div>',
      '</div>',
      '<div id="editImgProgress" class="d-none mb-3">',
      '<div class="eu-progress-bar-wrap"><div id="editImgBar" class="eu-progress-bar" style="width:0%"></div></div>',
      '<div class="small text-muted mt-1" id="editImgLabel">Subiendo...</div>',
      '</div>',
      '<div id="editUploadedImages" class="eu-media-grid"></div>',
      '</div>'
    ].join('');
  }

  function buildSourcesPanel(article) {
    var existingList = existingSources.length ? existingSources.map(function(s) {
      var icon = s.type === 'pdf'
        ? '<svg viewBox="0 0 24 24" fill="currentColor" style="width:16px;height:16px;flex-shrink:0;color:#dc2626"><path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/></svg>'
        : '<i class="bi bi-link-45deg" style="flex-shrink:0"></i>';
      return '<div class="eu-source-editor-item" id="existing-src-' + s.id + '">' + icon +
        '<span class="eu-source-title">' + escHtml(s.title) + '</span>' +
        '<button type="button" class="eu-source-action-btn" onclick="editExistingSource(' + article.id + ',' + s.id + ',\'' + escAttr(s.type) + '\',\'' + escAttr(s.title) + '\',\'' + escAttr(s.url||'') + '\')" title="Editar">‚úèÔ∏è</button>' +
        '<button type="button" class="eu-source-insert-btn" onclick="insertExistingSourceRef(' + s.id + ',\'' + escAttr(s.title) + '\')">Citar</button>' +
        '<button type="button" class="eu-source-delete-btn" onclick="deleteExistingSource(' + article.id + ',' + s.id + ')">‚úï</button>' +
        '</div>';
    }).join('') : '<div class="text-muted text-center p-2 small">No hay fuentes existentes</div>';

    return [
      '<div class="eu-card p-4 mb-4">',
      '<h5 class="mb-1"><i class="bi bi-link-45deg me-2"></i>Fuentes del art√≠culo</h5>',

      '<div class="mb-3">',
      '<div class="fw-semibold small mb-2">Fuentes actuales</div>',
      '<div class="eu-sources-editor mb-2">' + existingList + '</div>',
      '</div>',

      '<div class="mb-3 pb-3" style="border-bottom:1px solid var(--eu-border)">',
      '<div class="fw-semibold small mb-2">üîó A√±adir enlace</div>',
      '<input type="text" id="editSrcLinkTitle" class="eu-input mb-2" placeholder="T√≠tulo">',
      '<input type="url" id="editSrcLinkUrl" class="eu-input mb-2" placeholder="https://...">',
      '<button type="button" class="eu-btn-outline eu-btn-sm w-100" onclick="addEditLinkSource(' + article.id + ')"><i class="bi bi-plus-circle"></i> A√±adir enlace</button>',
      '</div>',

      '<div class="mb-2">',
      '<div class="fw-semibold small mb-2">üìÑ A√±adir PDF</div>',
      '<input type="text" id="editSrcPdfTitle" class="eu-input mb-2" placeholder="T√≠tulo del PDF">',
      '<div id="editPdfAttachZone">',
      '<label class="eu-btn-outline eu-btn-sm w-100 text-center" style="cursor:pointer">',
      '<i class="bi bi-paperclip"></i> Adjuntar PDF (m√°x 10MB)',
      '<input type="file" id="editSrcPdfInput" accept=".pdf" class="d-none" onchange="attachEditPdf(this)">',
      '</label>',
      '</div>',
      '<div id="editPdfPreview" class="d-none mt-2 p-2 rounded d-flex align-items-center gap-2" style="background:var(--eu-bg-secondary);border:1px solid var(--eu-border)">',
      '<svg viewBox="0 0 24 24" fill="currentColor" style="width:16px;height:16px;flex-shrink:0;color:#dc2626"><path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/></svg>',
      '<span class="small" id="editPdfPreviewName" style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap"></span>',
      '<button type="button" class="eu-source-delete-btn" onclick="clearEditPdfAttach()">‚úï</button>',
      '</div>',
      '<button type="button" class="eu-btn-primary eu-btn-sm w-100 mt-2 d-none" id="editAddPdfBtn" onclick="uploadEditPdfSource(' + article.id + ')"><i class="bi bi-upload"></i> Subir PDF</button>',
      '</div>',

      '<div id="editSourcesMsg" class="mt-1"></div>',
      '</div>'
    ].join('');
  }

  // ‚îÄ‚îÄ SUMMARY HELPERS (edit) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  window.summaryWrapEdit = function(before, after) {
    var ta = document.getElementById('editSummary');
    var s = ta.selectionStart, e = ta.selectionEnd;
    var sel = ta.value.substring(s, e) || 'texto';
    var st = ta.scrollTop;
    ta.value = ta.value.substring(0, s) + before + sel + after + ta.value.substring(e);
    ta.selectionStart = s + before.length;
    ta.selectionEnd = s + before.length + sel.length;
    ta.scrollTop = st;
    ta.focus();
  };
  window.summaryLineEdit = function(prefix) {
    var ta = document.getElementById('editSummary');
    var s = ta.selectionStart;
    var start = ta.value.lastIndexOf('\n', s - 1) + 1;
    var st = ta.scrollTop;
    ta.value = ta.value.substring(0, start) + prefix + ta.value.substring(start);
    ta.selectionStart = ta.selectionEnd = start + prefix.length;
    ta.scrollTop = st;
    ta.focus();
  };
  window.summaryAnchorEdit = function() {
    var id = prompt('ID del t√≠tulo:');
    if (!id) return;
    var label = prompt('Texto del enlace:') || id;
    var ta = document.getElementById('editSummary');
    var pos = ta.selectionStart;
    var st = ta.scrollTop;
    ta.value = ta.value.slice(0, pos) + '[' + label + '](#' + id + ')' + ta.value.slice(pos);
    ta.scrollTop = st;
    ta.focus();
  };

  // ‚îÄ‚îÄ NO-SCROLL INSERT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function noScrollInsert(ta, text, from, to) {
    var pageY = window.scrollY, taTop = ta.scrollTop;
    ta.value = ta.value.slice(0, from) + text + ta.value.slice(to);
    ta.scrollTop = taTop;
    window.scrollTo({ top: pageY });
  }

  window.wrap = function(before, after) {
    var ta = document.getElementById('editContent');
    var s = ta.selectionStart, e = ta.selectionEnd;
    var sel = ta.value.substring(s, e) || 'texto';
    noScrollInsert(ta, before + sel + after, s, e);
    ta.focus();
    ta.setSelectionRange(s + before.length, s + before.length + sel.length);
  };
  window.insertLine = function(prefix) {
    var ta = document.getElementById('editContent');
    var s = ta.selectionStart;
    var start = ta.value.lastIndexOf('\n', s - 1) + 1;
    noScrollInsert(ta, prefix, start, start);
    ta.focus();
    ta.setSelectionRange(start + prefix.length, start + prefix.length);
  };
  window.insertSCEdit = function(sc) {
    var ta = document.getElementById('editContent');
    var pos = ta.selectionStart;
    noScrollInsert(ta, '\n' + sc + '\n', pos, pos);
    ta.focus();
  };
  window.insertLinkEdit = function() {
    var url = prompt('URL del enlace:');
    if (!url) return;
    var label = prompt('Texto:') || url;
    var ta = document.getElementById('editContent');
    var pos = ta.selectionStart;
    noScrollInsert(ta, '[' + label + '](' + url + ')', pos, pos);
    ta.focus();
  };
  window.insertEditImageSC = function(url, alt) {
    var ta = document.getElementById('editContent');
    var pos = ta.selectionStart;
    noScrollInsert(ta, '\n[img file="' + url + '" alt="' + alt + '" caption=""]\n', pos, pos);
    ta.focus();
    window.showToast('Imagen insertada', 'success');
  };
  window.insertExistingSourceRef = function(id, title) {
    var ta = document.getElementById('editContent');
    var pos = ta.selectionStart;
    noScrollInsert(ta, '[source-ref title="' + escAttr(title) + '"]', pos, pos);
    ta.focus();
    window.showToast('Referencia insertada', 'success');
  };

  window.handleEditDrop = function(e) {
    e.preventDefault();
    document.getElementById('editUploadArea').classList.remove('dragover');
    if (e.dataTransfer.files.length) uploadEditImages(e.dataTransfer.files);
  };

  // ‚îÄ‚îÄ IMAGE UPLOAD (edit) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function loadExistingImages(artId) {
    try {
      var res = await fetch(API + '/api/media/article/' + artId);
      if (!res.ok) return;
      var images = await res.json();
      if (!images.length) return;
      var container = document.getElementById('editUploadedImages');
      images.forEach(function(img) {
        appendEditThumb(container, img.id, img.public_url, img.filename);
      });
    } catch(e) {}
  }

  function appendEditThumb(container, mediaId, url, filename) {
    var altName = filename.replace(/\.[^.]+$/, '');
    var div = document.createElement('div');
    div.className = 'eu-media-thumb';
    div.dataset.mediaId = mediaId;
    div.innerHTML =
      '<img src="' + escHtml(url) + '" alt="' + escHtml(filename) + '" loading="lazy">' +
      '<div class="eu-media-thumb-overlay">' +
      '<button type="button" onclick="insertEditImageSC(\'' + escAttr(url) + '\',\'' + escAttr(altName) + '\')">üì• Insertar</button>' +
      '<button type="button" onclick="deleteEditImage(' + mediaId + ', this)" style="color:#fca5a5">üóë Eliminar</button>' +
      '</div>';
    container.appendChild(div);
  }

  window.deleteEditImage = async function(mediaId, btn) {
    if (!confirm('¬øEliminar esta imagen?')) return;
    btn.disabled = true; btn.textContent = '...';
    var token = Auth.getToken();
    try {
      var res = await fetch(API + '/api/media/' + mediaId, {
        method: 'DELETE',
        headers: { Authorization: 'Bearer ' + token }
      });
      if (!res.ok) { var d = await res.json(); throw new Error(d.error); }
      var thumb = btn.closest('.eu-media-thumb');
      if (thumb) { thumb.style.transition='opacity .3s'; thumb.style.opacity='0'; setTimeout(function(){thumb.remove();},300); }
      window.showToast('Imagen eliminada','success');
    } catch(err) {
      window.showToast('Error: '+err.message,'error');
      btn.disabled=false; btn.textContent='üóë Eliminar';
    }
  };

  window.uploadEditImages = async function(files) {
    if (!articleData) return;
    var formData = new FormData();
    for (var i = 0; i < files.length; i++) formData.append('images', files[i]);
    formData.append('articleId', articleData.id);
    var token = Auth.getToken();

    var prog = document.getElementById('editImgProgress');
    var bar = document.getElementById('editImgBar');
    var lbl = document.getElementById('editImgLabel');
    prog.classList.remove('d-none');
    bar.style.width = '15%'; bar.style.background = '';
    lbl.textContent = 'Subiendo ' + files.length + ' imagen(es)...';
    var ticker = setInterval(function(){ bar.style.width = Math.min(parseFloat(bar.style.width)+7, 80) + '%'; }, 300);

    try {
      var res = await fetch(API + '/api/media/upload', {
        method: 'POST',
        headers: { Authorization: 'Bearer ' + token },
        body: formData
      });
      clearInterval(ticker);
      bar.style.width = '100%';
      var data = await res.json();
      if (!res.ok) throw new Error(data.error);
      lbl.textContent = '‚úì ' + data.files.length + ' imagen(es) subida(s)';
      setTimeout(function(){ prog.classList.add('d-none'); }, 2500);
      var container = document.getElementById('editUploadedImages');
      data.files.forEach(function(f) { appendEditThumb(container, f.id, f.publicUrl, f.filename); });
      window.showToast(data.files.length + ' imagen(es) subida(s)', 'success');
    } catch(err) {
      clearInterval(ticker);
      bar.style.width='100%'; bar.style.background='var(--eu-danger)';
      lbl.textContent = '‚úó ' + err.message;
      setTimeout(function(){ prog.classList.add('d-none'); bar.style.background=''; }, 3500);
      window.showToast(err.message,'error');
    }
  };

  // ‚îÄ‚îÄ SOURCES (edit) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function showEditSourceMsg(type, msg) {
    var el = document.getElementById('editSourcesMsg');
    el.innerHTML = '<div class="alert alert-' + type + ' py-2 px-3 small mb-0">' + escHtml(msg) + '</div>';
    setTimeout(function(){ if(el) el.innerHTML=''; }, 3500);
  }

  window.editExistingSource = async function(artId, srcId, type, currentTitle, currentUrl) {
    var newTitle = prompt('T√≠tulo:', currentTitle);
    if (newTitle === null) return;
    var payload = { title: newTitle.trim() || currentTitle };
    if (type === 'link') {
      var newUrl = prompt('URL:', currentUrl);
      if (newUrl !== null && newUrl.trim()) {
        try { new URL(newUrl.trim()); payload.url = newUrl.trim(); } catch(e) { window.showToast('URL inv√°lida','error'); return; }
      }
    }
    var token = Auth.getToken();
    try {
      var res = await fetch(API + '/api/articles/' + artId + '/sources/' + srcId, {
        method: 'PUT',
        headers: { 'Content-Type':'application/json', Authorization:'Bearer ' + token },
        body: JSON.stringify(payload)
      });
      if (!res.ok) { var d = await res.json(); throw new Error(d.error); }
      var el = document.getElementById('existing-src-' + srcId);
      if (el) {
        var span = el.querySelector('.eu-source-title');
        if (span) span.textContent = payload.title;
      }
      window.showToast('Fuente actualizada','success');
    } catch(e) {
      window.showToast('Error: ' + e.message,'error');
    }
  };

  window.deleteExistingSource = async function(artId, srcId) {
    if (!confirm('¬øEliminar esta fuente?')) return;
    var token = Auth.getToken();
    try {
      var res = await fetch(API + '/api/articles/' + artId + '/sources/' + srcId, {
        method: 'DELETE',
        headers: { Authorization: 'Bearer ' + token }
      });
      if (!res.ok) throw new Error('Error al eliminar');
      var el = document.getElementById('existing-src-' + srcId);
      if (el) { el.style.transition='opacity .3s'; el.style.opacity='0'; setTimeout(function(){el.remove();},300); }
      window.showToast('Fuente eliminada','success');
    } catch(e) {
      window.showToast(e.message,'error');
    }
  };

  window.addEditLinkSource = async function(artId) {
    var title = document.getElementById('editSrcLinkTitle').value.trim();
    var url = document.getElementById('editSrcLinkUrl').value.trim();
    if (!title || !url) { showEditSourceMsg('warning','T√≠tulo y URL requeridos'); return; }
    try { new URL(url); } catch(e) { showEditSourceMsg('warning','URL inv√°lida'); return; }

    // Show progress
    var btn = event.target;
    btn.disabled = true;
    btn.innerHTML = '<span class="eu-spinner" style="width:14px;height:14px;border-width:2px"></span> A√±adiendo...';

    var token = Auth.getToken();
    try {
      var res = await fetch(API + '/api/articles/' + artId + '/sources', {
        method: 'POST',
        headers: { 'Content-Type':'application/json', Authorization:'Bearer ' + token },
        body: JSON.stringify({ type:'link', title:title, url:url })
      });
      var data = await res.json();
      if (!res.ok) throw new Error(data.error);
      document.getElementById('editSrcLinkTitle').value = '';
      document.getElementById('editSrcLinkUrl').value = '';
      showEditSourceMsg('success','üîó Enlace a√±adido');

      var srcId = data.source ? data.source.id : Date.now();
      var container = document.querySelector('.eu-sources-editor');
      // Remove empty placeholder
      var emp = container.querySelector('.text-muted.text-center');
      if (emp) emp.remove();
      var div = document.createElement('div');
      div.className = 'eu-source-editor-item';
      div.id = 'existing-src-' + srcId;
      div.innerHTML =
        '<i class="bi bi-link-45deg" style="flex-shrink:0"></i>' +
        '<span class="eu-source-title">' + escHtml(title) + '</span>' +
        '<button type="button" class="eu-source-action-btn" onclick="editExistingSource(' + artId + ',' + srcId + ',\'link\',\'' + escAttr(title) + '\',\'' + escAttr(url) + '\')" title="Editar">‚úèÔ∏è</button>' +
        '<button type="button" class="eu-source-insert-btn" onclick="insertExistingSourceRef(' + srcId + ',\'' + escAttr(title) + '\')">Citar</button>' +
        '<button type="button" class="eu-source-delete-btn" onclick="deleteExistingSource(' + artId + ',' + srcId + ')">‚úï</button>';
      container.appendChild(div);
    } catch(e) {
      showEditSourceMsg('danger', escHtml(e.message));
    } finally {
      btn.disabled = false;
      btn.innerHTML = '<i class="bi bi-plus-circle"></i> A√±adir enlace';
    }
  };

  // PDF ‚Äî attach first, then upload on button click
  window.attachEditPdf = function(input) {
    var file = input.files[0];
    if (!file) return;
    if (file.size > 10 * 1024 * 1024) { showEditSourceMsg('warning','PDF supera 10MB'); input.value=''; return; }
    pendingPdf = { file: file, name: file.name };
    var title = document.getElementById('editSrcPdfTitle').value.trim() || file.name.replace(/\.pdf$/i,'');
    document.getElementById('editSrcPdfTitle').value = title;
    document.getElementById('editPdfPreviewName').textContent = file.name + ' (' + fmtSize(file.size) + ')';
    document.getElementById('editPdfPreview').classList.remove('d-none');
    document.getElementById('editAddPdfBtn').classList.remove('d-none');
    document.getElementById('editPdfAttachZone').classList.add('d-none');
  };

  window.clearEditPdfAttach = function() {
    pendingPdf = null;
    document.getElementById('editSrcPdfInput').value = '';
    document.getElementById('editPdfPreview').classList.add('d-none');
    document.getElementById('editAddPdfBtn').classList.add('d-none');
    document.getElementById('editPdfAttachZone').classList.remove('d-none');
  };

  window.uploadEditPdfSource = async function(artId) {
    if (!pendingPdf) return;
    var title = document.getElementById('editSrcPdfTitle').value.trim() || pendingPdf.name.replace(/\.pdf$/i,'');
    var btn = document.getElementById('editAddPdfBtn');
    btn.disabled = true;
    btn.innerHTML = '<span class="eu-spinner" style="width:14px;height:14px;border-width:2px"></span> Subiendo...';
    var token = Auth.getToken();
    var fd = new FormData();
    fd.append('pdf', pendingPdf.file);
    fd.append('title', title);
    try {
      var res = await fetch(API + '/api/articles/' + artId + '/sources/pdf', {
        method: 'POST',
        headers: { Authorization: 'Bearer ' + token },
        body: fd
      });
      var data = await res.json();
      if (!res.ok) throw new Error(data.error);
      clearEditPdfAttach();
      document.getElementById('editSrcPdfTitle').value = '';
      showEditSourceMsg('success','üìÑ PDF subido exitosamente');

      var srcId = data.source ? data.source.id : Date.now();
      var container = document.querySelector('.eu-sources-editor');
      var emp = container.querySelector('.text-muted.text-center');
      if (emp) emp.remove();
      var div = document.createElement('div');
      div.className = 'eu-source-editor-item';
      div.id = 'existing-src-' + srcId;
      div.innerHTML =
        '<svg viewBox="0 0 24 24" fill="currentColor" style="width:16px;height:16px;flex-shrink:0;color:#dc2626"><path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/></svg>' +
        '<span class="eu-source-title">' + escHtml(title) + '</span>' +
        '<button type="button" class="eu-source-action-btn" title="Renombrar PDF" onclick="renameExistingPdf(' + artId + ',' + srcId + ',\'' + escAttr(title) + '\')">‚úèÔ∏è</button>' +
        '<button type="button" class="eu-source-insert-btn" onclick="insertExistingSourceRef(' + srcId + ',\'' + escAttr(title) + '\')">Citar</button>' +
        '<button type="button" class="eu-source-delete-btn" onclick="deleteExistingSource(' + artId + ',' + srcId + ')">‚úï</button>';
      container.appendChild(div);
    } catch(e) {
      showEditSourceMsg('danger', escHtml(e.message));
      btn.disabled = false;
      btn.innerHTML = '<i class="bi bi-upload"></i> Subir PDF';
    }
  };

  window.renameExistingPdf = async function(artId, srcId, currentTitle) {
    var newTitle = prompt('T√≠tulo del PDF:', currentTitle);
    if (!newTitle || newTitle.trim() === currentTitle) return;
    var token = Auth.getToken();
    try {
      var res = await fetch(API + '/api/articles/' + artId + '/sources/' + srcId, {
        method: 'PUT',
        headers: { 'Content-Type':'application/json', Authorization:'Bearer ' + token },
        body: JSON.stringify({ title: newTitle.trim() })
      });
      if (!res.ok) { var d = await res.json(); throw new Error(d.error); }
      var el = document.getElementById('existing-src-' + srcId);
      if (el) { var sp = el.querySelector('.eu-source-title'); if(sp) sp.textContent = newTitle.trim(); }
      window.showToast('PDF renombrado','success');
    } catch(e) { window.showToast('Error: '+e.message,'error'); }
  };

  // ‚îÄ‚îÄ SUBMIT EDIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  window.submitEdit = async function(articleId) {
    var title   = document.getElementById('editTitle')?.value.trim();
    var summary = document.getElementById('editSummary')?.value.trim();
    var content = document.getElementById('editContent')?.value.trim();
    var note    = document.getElementById('editNote')?.value.trim();
    var msgEl   = document.getElementById('submitMsg');
    var btn     = document.getElementById('submitBtn');
    var spinner = document.getElementById('submitSpinner');

    if (!content) {
      msgEl.innerHTML = '<div class="alert alert-warning mb-3"><i class="bi bi-exclamation-triangle me-2"></i>El contenido no puede estar vac√≠o.</div>';
      return;
    }
    btn.disabled = true;
    spinner.classList.remove('d-none');
    msgEl.innerHTML = '';

    try {
      var res = await Auth.authFetch(API + '/api/articles/' + articleId + '/edit', {
        method: 'POST',
        body: JSON.stringify({ title:title, summary:summary, content:content, editNote:note })
      });
      var data = await res.json();
      if (!res.ok) throw new Error(data.error || 'Error al enviar edici√≥n');
      msgEl.innerHTML = '<div class="alert alert-success mb-4"><i class="bi bi-check-circle-fill me-2"></i><strong>¬°Edici√≥n enviada!</strong> Un moderador la revisar√°.<div class="mt-3"><a href="' + BASE + '/articulo.html?slug=' + encodeURIComponent(slug) + '" class="btn btn-sm btn-outline-success">Ver art√≠culo original</a></div></div>';
      document.querySelectorAll('.eu-card').forEach(function(el){ el.style.display='none'; });
    } catch(e) {
      msgEl.innerHTML = '<div class="alert alert-danger mb-3"><i class="bi bi-x-circle me-2"></i>' + escHtml(e.message) + '</div>';
    } finally {
      btn.disabled = false;
      spinner.classList.add('d-none');
    }
  };

  function renderError(msg) {
    document.getElementById('editorPage').innerHTML = '<div class="eu-empty-state" style="min-height:50vh"><i class="bi bi-exclamation-circle" style="font-size:3rem;color:var(--eu-danger)"></i><h3 class="mt-3">No se puede cargar el editor</h3><p class="text-muted">' + escHtml(msg) + '</p><a href="' + BASE + '/" class="eu-btn-primary mt-3">Ir al inicio</a></div>';
  }

  function fmtSize(bytes) {
    var k = 1024, s = ['B','KB','MB'];
    var i = Math.floor(Math.log(bytes) / Math.log(k));
    return (bytes / Math.pow(k, i)).toFixed(1) + ' ' + s[i];
  }
  function escHtml(s) { return String(s||'').replace(/[&<>"']/g,function(c){return({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]);}); }
  function escAttr(s) { return escHtml(s); }
})();
</script>
