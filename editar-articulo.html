---
layout: default
title: Editar art√≠culo
---

<div id="editorPage" style="max-width:1000px;margin:0 auto;padding:32px 20px">
  <div class="eu-loading" style="min-height:50vh">
    <div class="eu-spinner"></div>
    <span>Cargando art√≠culo...</span>
  </div>
</div>

<script>
(function() {
  const API  = window.EU_CONFIG.backendUrl;
  const BASE = window.EU_CONFIG.baseUrl;
  const params = new URLSearchParams(window.location.search);
  const slug   = params.get('slug');
  const articleId = params.get('id');

  let originalArticle = null;

  document.addEventListener('DOMContentLoaded', async () => {
    if (!Auth.isLoggedIn()) {
      window.location.href = `${BASE}/login.html?redirect=${encodeURIComponent(window.location.href)}`;
      return;
    }
    if (!slug && !articleId) {
      renderError('No se especific√≥ el art√≠culo a editar.');
      return;
    }
    await loadArticle();
  });

  async function loadArticle() {
    try {
      // Fetch the article to pre-fill the form
      const res  = await fetch(`${API}/api/articles/${slug || ''}${slug ? '' : '?id='+articleId}`);
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'Art√≠culo no encontrado');
      originalArticle = data;

      // Now fetch the raw markdown content
      let rawContent = '';
      try {
        const contentRes = await Auth.authFetch(`${API}/api/articles/by-id/${data.id}/content`);
        if (contentRes?.ok) {
          const cd = await contentRes.json();
          rawContent = cd.content || '';
        }
      } catch(e) { /* si no tiene permiso para ver el md, dejamos vac√≠o */ }

      renderEditor(data, rawContent);
    } catch(e) {
      renderError(e.message);
    }
  }

  function renderEditor(article, rawContent) {
    const user    = Auth.getUser();
    const isOwner = user && (user.id === article.author_id);
    const isMod   = user && ['MOD','ADMIN'].includes(user.role);

    document.getElementById('editorPage').innerHTML = `
      <div class="d-flex align-items-center gap-3 mb-4">
        <a href="${BASE}/articulo.html?slug=${encodeURIComponent(article.slug)}" class="eu-btn-outline btn-sm">
          <i class="bi bi-arrow-left"></i> Volver al art√≠culo
        </a>
        <h1 style="font-family:var(--eu-font-display);font-size:1.4rem;margin:0;flex:1" class="text-truncate">
          Proponer edici√≥n: ${escHtml(article.title)}
        </h1>
      </div>

      <div class="alert alert-info mb-4">
        <i class="bi bi-info-circle me-2"></i>
        Tu edici√≥n quedar√° <strong>pendiente de aprobaci√≥n</strong> por un moderador antes de publicarse.
        Solo se publicar√° si mejora el art√≠culo original.
      </div>

      <div id="submitMessage"></div>

      <div class="eu-card p-4 mb-4">
        <div class="mb-3">
          <label class="eu-label">T√≠tulo <span class="text-muted small">(dejar vac√≠o para mantener el original)</span></label>
          <input type="text" id="editTitle" class="eu-input" value="${escHtml(article.title)}"
                 placeholder="${escHtml(article.title)}" maxlength="500">
        </div>
        <div class="mb-3">
          <label class="eu-label">Resumen <span class="text-muted small">(dejar vac√≠o para mantener el original)</span></label>
          <textarea id="editSummary" class="eu-input" rows="2"
                    placeholder="${escHtml(article.summary)}">${escHtml(article.summary)}</textarea>
        </div>
        <div class="mb-3">
          <label class="eu-label">Contenido Markdown <span class="text-danger">*</span></label>

          <!-- Toolbar -->
          <div class="eu-editor-toolbar mb-1">
            <button type="button" class="eu-toolbar-btn" onclick="wrap('**','**')" title="Negrita"><i class="bi bi-type-bold"></i></button>
            <button type="button" class="eu-toolbar-btn" onclick="wrap('*','*')" title="Cursiva"><i class="bi bi-type-italic"></i></button>
            <button type="button" class="eu-toolbar-btn" onclick="wrap('`','`')" title="C√≥digo"><i class="bi bi-code"></i></button>
            <button type="button" class="eu-toolbar-btn" onclick="insertLine('## ')" title="T√≠tulo">H2</button>
            <button type="button" class="eu-toolbar-btn" onclick="insertLine('### ')" title="Subt√≠tulo">H3</button>
            <button type="button" class="eu-toolbar-btn" onclick="insertLine('- ')" title="Lista"><i class="bi bi-list-ul"></i></button>
            <button type="button" class="eu-toolbar-btn" onclick="insertLine('> ')" title="Cita"><i class="bi bi-blockquote-left"></i></button>
            <span class="eu-toolbar-divider"></span>
            <button type="button" class="eu-toolbar-btn" onclick="insertShortcode('[tooltip text=\"definici√≥n\"]t√©rmino[/tooltip]')" title="Tooltip">üí¨</button>
            <button type="button" class="eu-toolbar-btn" onclick="insertShortcode('[alert type=\"info\"]mensaje[/alert]')" title="Alerta">‚ö†Ô∏è</button>
            <button type="button" class="eu-toolbar-btn" onclick="insertShortcode('[callout icon=\"üí°\"]nota importante[/callout]')" title="Callout">üìå</button>
          </div>

          <div style="position:relative">
            <textarea id="editContent" class="eu-input eu-editor-textarea" rows="20"
                      placeholder="Escribe el contenido en Markdown..."
                      spellcheck="false">${escHtml(rawContent)}</textarea>
            <div style="position:absolute;bottom:8px;right:10px;font-size:.75rem;color:var(--eu-text-muted)">
              <span id="charCount">0</span> caracteres
            </div>
          </div>
        </div>
        <div class="mb-3">
          <label class="eu-label">Nota para los moderadores <span class="text-muted small">(opcional)</span></label>
          <textarea id="editNote" class="eu-input" rows="2"
                    placeholder="Explica brevemente qu√© cambiaste y por qu√© (ej: correcci√≥n ortogr√°fica, datos actualizados, secci√≥n nueva...)"></textarea>
        </div>

        <div class="d-flex gap-3 align-items-center flex-wrap">
          <button class="eu-btn-primary" onclick="submitEdit(${article.id})">
            <i class="bi bi-send"></i> Enviar edici√≥n
          </button>
          <a href="${BASE}/articulo.html?slug=${encodeURIComponent(article.slug)}" class="eu-btn-outline">
            Cancelar
          </a>
          <span id="submitSpinner" class="d-none">
            <div class="eu-spinner" style="width:20px;height:20px"></div>
          </span>
        </div>
      </div>

      <!-- Comparaci√≥n con original -->
      <div class="eu-card p-4">
        <h4 style="font-size:1rem;font-weight:700;margin-bottom:12px">
          <i class="bi bi-file-earmark-text me-2"></i>Art√≠culo original (referencia)
        </h4>
        <div style="background:var(--eu-bg-secondary);padding:16px;border-radius:var(--eu-radius-sm);max-height:300px;overflow-y:auto">
          <p class="text-muted small mb-1">Resumen original:</p>
          <p style="font-size:.9rem">${escHtml(article.summary)}</p>
          ${rawContent ? `
          <p class="text-muted small mb-1 mt-3">Contenido original (Markdown):</p>
          <pre style="font-size:.8rem;white-space:pre-wrap;word-break:break-word;margin:0">${escHtml(rawContent)}</pre>` : ''}
        </div>
      </div>`;

    // Char counter
    const ta = document.getElementById('editContent');
    const cc = document.getElementById('charCount');
    function updateCount() { cc.textContent = (ta.value.length).toLocaleString('es-AR'); }
    ta.addEventListener('input', updateCount);
    updateCount();
  }

  window.submitEdit = async function(id) {
    const title   = document.getElementById('editTitle')?.value.trim();
    const summary = document.getElementById('editSummary')?.value.trim();
    const content = document.getElementById('editContent')?.value.trim();
    const note    = document.getElementById('editNote')?.value.trim();
    const msgEl   = document.getElementById('submitMessage');
    const spinner = document.getElementById('submitSpinner');

    if (!content) {
      msgEl.innerHTML = '<div class="alert alert-warning mb-3"><i class="bi bi-exclamation-triangle me-2"></i>El contenido es obligatorio.</div>';
      return;
    }

    spinner.classList.remove('d-none');
    document.querySelector('.eu-btn-primary').disabled = true;
    msgEl.innerHTML = '';

    try {
      const res  = await Auth.authFetch(`${API}/api/articles/${id}/edit`, {
        method: 'POST',
        body: JSON.stringify({ title, summary, content, editNote: note })
      });
      const data = await res.json();

      if (!res.ok) throw new Error(data.error || 'Error al enviar edici√≥n');

      msgEl.innerHTML = `<div class="alert alert-success mb-3">
        <i class="bi bi-check-circle me-2"></i>
        <strong>¬°Edici√≥n enviada!</strong> Quedar√° pendiente de revisi√≥n por un moderador.
        <div class="mt-2">
          <a href="${BASE}/articulo.html?slug=${encodeURIComponent(slug)}" class="alert-link">
            Volver al art√≠culo ‚Üí
          </a>
        </div>
      </div>`;
      document.querySelector('.eu-btn-primary').classList.add('d-none');
    } catch(e) {
      msgEl.innerHTML = `<div class="alert alert-danger mb-3">
        <i class="bi bi-x-circle me-2"></i>${escHtml(e.message)}
      </div>`;
    } finally {
      spinner.classList.add('d-none');
      document.querySelector('.eu-btn-primary').disabled = false;
    }
  };

  // Editor helpers
  window.wrap = function(before, after) {
    const ta  = document.getElementById('editContent');
    const s   = ta.selectionStart, e = ta.selectionEnd;
    const sel = ta.value.substring(s, e) || 'texto';
    ta.value  = ta.value.substring(0, s) + before + sel + after + ta.value.substring(e);
    ta.selectionStart = s + before.length;
    ta.selectionEnd   = s + before.length + sel.length;
    ta.focus();
  };
  window.insertLine = function(prefix) {
    const ta = document.getElementById('editContent');
    const s  = ta.selectionStart;
    const lineStart = ta.value.lastIndexOf('\n', s - 1) + 1;
    ta.value = ta.value.substring(0, lineStart) + prefix + ta.value.substring(lineStart);
    ta.selectionStart = ta.selectionEnd = lineStart + prefix.length;
    ta.focus();
  };
  window.insertShortcode = function(sc) {
    const ta = document.getElementById('editContent');
    const s  = ta.selectionStart;
    ta.value = ta.value.substring(0, s) + '\n' + sc + '\n' + ta.value.substring(s);
    ta.selectionStart = ta.selectionEnd = s + sc.length + 2;
    ta.focus();
  };

  function renderError(msg) {
    document.getElementById('editorPage').innerHTML = `
      <div class="eu-empty-state" style="min-height:50vh">
        <i class="bi bi-exclamation-circle fs-1 text-danger"></i>
        <h3 class="mt-3">Error</h3>
        <p class="text-muted">${escHtml(msg)}</p>
        <a href="${BASE}/" class="eu-btn-primary mt-3">Ir al inicio</a>
      </div>`;
  }

  function escHtml(s) {
    return String(s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }
})();
</script>
